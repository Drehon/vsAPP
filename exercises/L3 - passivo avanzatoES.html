<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esercizi Pratici: I Passivi Avanzati</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-200 */
        }
        .key-rule {
            background-color: #eef2ff; /* bg-indigo-50 */
            color: #3730a3; /* text-indigo-800 */
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .student-response {
            background-color: #fffbeb; /* bg-amber-50 */
            border-left: 4px solid #f59e0b; /* border-amber-500 */
            padding: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        h1, h2, h3, h4 {
            font-weight: 700;
        }
        code, .font-mono {
            font-family: 'Source Code Pro', monospace;
        }
        /* Custom styles for tabs and feedback */
        .tab-btn {
            color: #64748b; /* text-slate-500 */
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-btn:hover {
            color: #475569; /* text-slate-600 */
        }
        .tab-active {
            color: #4f46e5; /* text-indigo-600 */
            border-color: #4f46e5; /* border-indigo-600 */
            font-weight: 600;
        }
        .tab-inactive {
            color: #64748b; /* text-slate-500 */
        }
        .feedback-correct {
            border-color: #10b981; /* green-500 */
            background-color: #ecfdf5; /* green-50 */
        }
        .feedback-incorrect {
            border-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
        .explanation {
            color: #475569; /* text-slate-600 */
        }
    </style>
</head>
<body class="text-slate-700">

    <div class="container mx-auto p-6 md:p-10 max-w-7xl">

        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <header class="p-6">
                <h1 class="text-3xl font-bold text-slate-900">Esercizi Pratici: I Passivi Avanzati</h1>
                <p class="text-lg text-slate-600">Metti in pratica la teoria con esercizi mirati.</p>
            </header>
            <div class="p-6 border-t border-slate-200 bg-slate-50 text-sm text-slate-600 space-y-3">
                <h3 class="font-semibold text-slate-800">Come usare questa pagina:</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li><strong>Salvataggio Automatico:</strong> I tuoi progressi (risposte e note) vengono salvati costantemente.</li>
                    <li><strong>Pulsanti di Navigazione:</strong> Utilizza i pulsanti sulla barra degli strumenti per navigare tra le schede, salvare e caricare i progressi o ripristinare l'esercizio.</li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Tabs -->
            <div class="border-b border-slate-200">
                <nav class="flex space-x-6 px-6" aria-label="Tabs">
                    <button id="tab-btn-1" data-tab="1" class="tab-btn py-4 px-1 text-sm font-medium tab-active">Fase 1: Comprensione</button>
                    <button id="tab-btn-2" data-tab="2" class="tab-btn py-4 px-1 text-sm font-medium tab-inactive">Fase 2: Riconoscimento</button>
                    <button id="tab-btn-3" data-tab="3" class="tab-btn py-4 px-1 text-sm font-medium tab-inactive">Fase 3: Produzione</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6 md:p-8">
                <div id="tab-content-1" class="tab-content"></div>
                <div id="tab-content-2" class="tab-content hidden"></div>
                <div id="tab-content-3" class="tab-content hidden"></div>
            </div>
        </div>
    </div>

    <script id="exercise-data" type="application/json">
        {
            "fase1": [
                { "question": "La frase 'I was given a book' è un esempio di passivo con due oggetti.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'A book' è l'oggetto diretto, e 'I' (il destinatario) è l'oggetto indiretto dalla forma attiva, che ora funge da soggetto." },
                { "question": "Nella frase 'It is believed that he is innocent', 'it' si riferisce a una persona specifica.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "'It' è un soggetto impersonale, usato per introdurre un'opinione generale." },
                { "question": "La frase 'He is said to be a genius' è la forma passiva di 'People say he is a genius'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. È una costruzione passiva comune per esprimere opinioni generali." },
                { "question": "La struttura 'have something done' è usata per indicare che si fa qualcosa personalmente.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Significa che si fa fare qualcosa da qualcun altro." },
                { "question": "Nella frase 'The house is being built', l'azione è già completata.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "'Is being built' indica un'azione in corso (Present Continuous Passivo)." },
                { "question": "La frase 'The criminal was caught red-handed' è un esempio di passivo con un complemento di modo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Red-handed' descrive il modo in cui è stato catturato." },
                { "question": "La struttura 'It was decided that...' è più formale di 'They decided that...'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. L'uso del passivo impersonale è spesso più formale e oggettivo." },
                { "question": "Nella frase 'He was made to confess', 'to confess' è un infinito senza 'to'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Nella forma passiva di 'make', si aggiunge 'to' prima dell'infinito." },
                { "question": "La frase 'The problem needs solving' ha lo stesso significato di 'The problem needs to be solved'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Entrambe le forme esprimono la necessità di un'azione passiva." },
                { "question": "La frase 'The children were given a reward by their parents' è un passivo con 'by' per indicare l'agente.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'By their parents' specifica chi ha dato la ricompensa." },
                { "question": "Nella frase 'The book is thought to be lost', l'azione di 'thinking' è al passato.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "'Is thought' è al presente. L'azione di 'losing' potrebbe essere al passato." },
                { "question": "La frase 'He was seen leaving the building' è un passivo con un participio presente.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Leaving' è un participio presente che descrive l'azione in corso." },
                { "question": "La struttura 'get + participio passato' è più formale di 'be + participio passato'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "'Get' è spesso usato in contesti informali o per azioni che accadono inaspettatamente." },
                { "question": "La frase 'The new policy has been announced' è al Present Perfect Passivo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Has been announced' indica un'azione completata con rilevanza nel presente." },
                { "question": "Nella frase 'She was told to wait', l'agente che ha detto di aspettare è sconosciuto.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Il passivo si usa spesso quando l'agente è sconosciuto o non importante." },
                { "question": "La frase 'The car needs to be washed' è un esempio di passivo impersonale.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. È un passivo che si riferisce a un oggetto specifico ('the car')." },
                { "question": "La frase 'It is said that money doesn't buy happiness' usa una clausola 'that'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'That money doesn't buy happiness' è la clausola nominale." },
                { "question": "Nella frase 'He was believed to have escaped', l'azione di 'escaping' è avvenuta prima dell'azione di 'believing'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'To have escaped' è l'infinito perfetto, che indica un'azione precedente." },
                { "question": "La frase 'The bridge was built in 1900' è un passivo al Simple Past.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Was built' è la forma passiva del Simple Past." },
                { "question": "La struttura 'There is said to be...' è usata per introdurre un'informazione generica.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Simile a 'It is said that...', ma con 'there' per l'esistenza." },
                { "question": "La frase 'He gets paid weekly' è un esempio di passivo con 'get'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Gets paid' è una forma comune di passivo in contesti informali o per azioni abituali." },
                { "question": "Nella frase 'The decision was made by the committee', 'by the committee' è un complemento d'agente.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Indica chi ha compiuto l'azione." },
                { "question": "La frase 'The window broke' è un passivo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. È un'azione intransitiva, non passiva. Non c'è un agente che compie l'azione sulla finestra." },
                { "question": "La struttura 'be + to + infinito' (es. 'The new rules are to be followed') esprime un obbligo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Indica un dovere o un'istruzione." },
                { "question": "Nella frase 'I was advised to study hard', l'agente è sempre specificato.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. L'agente non è specificato in questo esempio." },
                { "question": "La frase 'The book is being read by millions' è al Present Perfect Continuous Passivo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. È al Present Continuous Passivo." },
                { "question": "La struttura 'It is thought that...' è usata per esprimere una certezza assoluta.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. Esprime un'opinione o una credenza, non una certezza assoluta." },
                { "question": "La frase 'He was given a second chance' è un passivo con un oggetto indiretto come soggetto.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'He' è l'oggetto indiretto del verbo 'give' nella forma attiva." },
                { "question": "La frase 'The door was painted green' è un passivo con un complemento predicativo dell'oggetto.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Green' descrive il risultato dell'azione sul soggetto ('the door')." },
                { "question": "La struttura 'There is believed to be...' è sempre seguita da un plurale.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. Dipende dal sostantivo che segue 'to be'. Es: 'There is believed to be a solution' (singolare)." },
                { "question": "La frase 'The car got damaged in the accident' è un passivo con 'get'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Get damaged' è un passivo che indica un cambiamento di stato o un evento inaspettato." },
                { "question": "La frase 'He was heard to sing' è più comune di 'He was heard singing'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. 'He was heard singing' è più comune e indica l'azione in corso." },
                { "question": "La frase 'The report is to be submitted by Friday' esprime un obbligo o una disposizione.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Is to be submitted' indica una scadenza o un requisito." },
                { "question": "Nella frase 'The building was thought to have been destroyed', l'azione di 'destroying' è avvenuta prima di 'thinking'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'To have been destroyed' è l'infinito perfetto passivo, che indica un'azione completata prima del verbo principale." },
                { "question": "La frase 'The rules are being explained now' è al Present Simple Passivo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. È al Present Continuous Passivo, indica un'azione in corso." },
                { "question": "La struttura 'It is known that...' è usata per informazioni ampiamente accettate.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Indica una conoscenza o un fatto generale." },
                { "question": "La frase 'I was made do it' è grammaticalmente corretta.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. Dopo il passivo di 'make', si usa 'to' prima del verbo: 'I was made to do it'." },
                { "question": "La frase 'The children were allowed to play outside' è un passivo di 'allow'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. È la forma passiva di 'They allowed the children to play outside'." },
                { "question": "Nella frase 'The house needs painting', 'painting' è un gerundio con significato passivo.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Si usa il gerundio dopo 'need' per esprimere una necessità passiva." },
                { "question": "La frase 'The problem is being discussed' significa che qualcuno sta discutendo il problema.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Il Present Continuous Passivo indica un'azione in corso." },
                { "question": "La frase 'He is understood to be a spy' è più comune di 'People understand he is a spy'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. È una costruzione passiva più formale e concisa." },
                { "question": "La frase 'The package was sent yesterday' è un passivo senza agente specificato.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. L'agente non è menzionato." },
                { "question": "La struttura 'It is believed to have been...' si usa per eventi recenti.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. Si usa per eventi che si ritiene siano accaduti nel passato, anche remoto." },
                { "question": "La frase 'The car was driven by a robot' è un passivo con un agente non umano.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Il complemento d'agente può essere anche non umano." },
                { "question": "La frase 'The news was reported on TV' è un passivo senza 'by' perché il mezzo è ovvio.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. Quando l'agente è generico o ovvio, si omette 'by'." },
                { "question": "Nella frase 'The patient was operated on immediately', 'on' è necessario.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Operate on' è un verbo frasale e la preposizione è parte integrante." },
                { "question": "La frase 'He was given good advice' è corretta.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'Advice' è un sostantivo non numerabile, quindi non ha 'a' o 'an'." },
                { "question": "La struttura 'It is hoped that...' esprime una speranza generale.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. È un passivo impersonale per esprimere una speranza collettiva." },
                { "question": "La frase 'The children were seen to play in the park' è più comune di 'The children were seen playing in the park'.", "type": "mc", "options": ["Vero", "Falso"], "answer": "B", "explanation": "Falso. 'Seen playing' è più comune e indica l'azione in corso." },
                { "question": "La frase 'The project is considered a success' è un passivo con un complemento del soggetto.", "type": "mc", "options": ["Vero", "Falso"], "answer": "A", "explanation": "Corretto. 'A success' è un complemento del soggetto che descrive il progetto." }
            ],
            "fase2": [
                { "question": "The new bridge ______ next year.", "options": ["is building", "will be built", "is built", "builds"], "answer": "B", "explanation": "Futuro Passivo: 'will be' + participio passato." },
                { "question": "It ______ that the economy will improve soon.", "options": ["is hoped", "hopes", "is hoping", "hoped"], "answer": "A", "explanation": "Passivo impersonale con 'it': 'it is hoped that...'" },
                { "question": "The children ______ a story by their grandmother every night.", "options": ["are told", "tell", "are telling", "told"], "answer": "A", "explanation": "Present Simple Passivo con due oggetti: 'are told' (la storia è raccontata a loro)." },
                { "question": "The documents ______ by the secretary right now.", "options": ["are being typed", "are typed", "are typing", "have typed"], "answer": "A", "explanation": "Present Continuous Passivo: 'are being' + participio passato." },
                { "question": "He ______ to be a very talented artist.", "options": ["is said", "says", "is saying", "said"], "answer": "A", "explanation": "Passivo con infinito: 'is said to be'." },
                { "question": "The broken window ______ immediately.", "options": ["needs fixing", "needs to fix", "needs be fixed", "needs fixed"], "answer": "A", "explanation": "Gerundio con significato passivo dopo 'need': 'needs fixing' o 'needs to be fixed'." },
                { "question": "A new hospital ______ in the city center.", "options": ["is to build", "is to be built", "is building", "builds"], "answer": "B", "explanation": "Passivo con 'be to': 'is to be built' per obbligo/disposizione futura." },
                { "question": "The decision ______ by the board yesterday.", "options": ["was made", "made", "has made", "is made"], "answer": "A", "explanation": "Past Simple Passivo: 'was made'." },
                { "question": "There ______ to be a solution to every problem.", "options": ["is believed", "believes", "is believing", "believed"], "answer": "A", "explanation": "Passivo impersonale con 'there': 'there is believed to be'." },
                { "question": "He ______ to have stolen the money.", "options": ["is suspected", "suspects", "is suspecting", "suspected"], "answer": "A", "explanation": "Passivo con infinito perfetto: 'is suspected to have stolen'." },
                { "question": "The new rules ______ by all employees.", "options": ["must follow", "must be followed", "must being followed", "must have followed"], "answer": "B", "explanation": "Passivo con modale: 'must be' + participio passato." },
                { "question": "He ______ seen entering the building.", "options": ["was", "is", "has been", "had been"], "answer": "A", "explanation": "Passivo con verbo di percezione: 'was seen' + gerundio o infinito senza 'to'." },
                { "question": "The house ______ last year.", "options": ["got painted", "painted", "gets painted", "is painting"], "answer": "A", "explanation": "Passivo con 'get' per un'azione completata nel passato: 'got painted'." },
                { "question": "It ______ that the world is round.", "options": ["is known", "knows", "is knowing", "knew"], "answer": "A", "explanation": "Passivo impersonale con 'it': 'it is known that...'" },
                { "question": "The report ______ by Friday.", "options": ["is to submit", "is to be submitted", "submits", "will submit"], "answer": "B", "explanation": "Passivo con 'be to': 'is to be submitted' per obbligo/scadenza." },
                { "question": "The children ______ to clean their rooms.", "options": ["were made", "made", "were making", "are made"], "answer": "A", "explanation": "Passivo di 'make': 'were made to' + infinito." },
                { "question": "He ______ a new car for his birthday.", "options": ["was given", "gave", "was giving", "is giving"], "answer": "A", "explanation": "Passivo con due oggetti: 'was given' (la macchina gli è stata data)." },
                { "question": "The problem ______ by the team for hours.", "options": ["has been discussed", "has discussed", "is discussed", "discusses"], "answer": "A", "explanation": "Present Perfect Passivo: 'has been' + participio passato." },
                { "question": "The building ______ to have been built in the 18th century.", "options": ["is believed", "believes", "is believing", "believed"], "answer": "A", "explanation": "Passivo impersonale con infinito perfetto passivo: 'is believed to have been built'." },
                { "question": "The new manager ______ to be very strict.", "options": ["is considered", "considers", "is considering", "considered"], "answer": "A", "explanation": "Passivo con verbo di opinione: 'is considered to be'." },
                { "question": "The concert ______ by thousands of people.", "options": ["was attended", "attended", "was attending", "is attending"], "answer": "A", "explanation": "Past Simple Passivo: 'was attended'." },
                { "question": "It ______ that the earth is warming.", "options": ["is generally accepted", "generally accepts", "is generally accepting", "generally accepted"], "answer": "A", "explanation": "Passivo impersonale con 'it': 'it is generally accepted that...'" },
                { "question": "The car ______ in the accident.", "options": ["got damaged", "damaged", "gets damaged", "is damaging"], "answer": "A", "explanation": "Passivo con 'get' per un evento inaspettato: 'got damaged'." },
                { "question": "The children ______ playing in the garden.", "options": ["were seen", "saw", "were seeing", "have seen"], "answer": "A", "explanation": "Passivo con verbo di percezione: 'were seen' + gerundio." },
                { "question": "The report ______ by the end of the month.", "options": ["needs completing", "needs to complete", "needs completed", "needs to be complete"], "answer": "A", "explanation": "Gerundio con significato passivo dopo 'need': 'needs completing'." },
                { "question": "The new system ______ to be installed next week.", "options": ["is expected", "expects", "is expecting", "expected"], "answer": "A", "explanation": "Passivo con infinito: 'is expected to be installed'." },
                { "question": "He ______ to have been a famous actor.", "options": ["is rumored", "rumors", "is rumoring", "rumored"], "answer": "A", "explanation": "Passivo con infinito perfetto passivo: 'is rumored to have been'." },
                { "question": "The patient ______ to take the medicine.", "options": ["was advised", "advised", "was advising", "is advising"], "answer": "A", "explanation": "Passivo con infinito: 'was advised to' + infinito." },
                { "question": "The project ______ to be completed by December.", "options": ["is scheduled", "schedules", "is scheduling", "scheduled"], "answer": "A", "explanation": "Passivo con infinito: 'is scheduled to be completed'." },
                { "question": "The ancient city ______ to exist deep in the jungle.", "options": ["is believed", "believes", "is believing", "believed"], "answer": "A", "explanation": "Passivo con infinito: 'is believed to exist'." }
            ],
            "fase3": [
                { "prompt": "People say that he is very rich.", "question": "He is said...", "type": "input_rewrite", "answer": "to be very rich", "explanation": "La risposta corretta è \"to be very rich\". La struttura è 'soggetto + is/are said + to be + complemento'." },
                { "prompt": "The company needs to clean the machines.", "question": "The machines need...", "type": "input_rewrite", "answer": "cleaning", "explanation": "La risposta corretta è \"cleaning\". Dopo 'need', si può usare il gerundio con significato passivo." },
                { "prompt": "They made him sign the contract.", "question": "He was made...", "type": "input_rewrite", "answer": "to sign the contract", "explanation": "La risposta corretta è \"to sign the contract\". Nella forma passiva di 'make', si aggiunge 'to' prima dell'infinito." },
                { "prompt": "Someone gave her a beautiful present.", "question": "She was given...", "type": "input_rewrite", "answer": "a beautiful present", "explanation": "La risposta corretta è \"a beautiful present\". Passivo con due oggetti: l'oggetto indiretto diventa soggetto." },
                { "prompt": "People believe that the ancient city exists.", "question": "The ancient city is believed...", "type": "input_rewrite", "answer": "to exist", "explanation": "La risposta corretta è \"to exist\". Struttura passiva con infinito." },
                { "prompt": "They are building a new school.", "question": "A new school is being...", "type": "input_rewrite", "answer": "built", "explanation": "La risposta corretta è \"built\". Present Continuous Passivo: 'is being' + participio passato." },
                { "prompt": "The police saw him run away.", "question": "He was seen...", "type": "input_rewrite", "answer": "running away", "explanation": "La risposta corretta è \"running away\". Passivo con verbo di percezione + gerundio (o infinito senza 'to')." },
                { "prompt": "It is necessary to follow these rules.", "question": "These rules are to...", "type": "input_rewrite", "answer": "be followed", "explanation": "La risposta corretta è \"be followed\". Passivo con 'be to' per esprimere obbligo." },
                { "prompt": "Someone damaged my car in the parking lot.", "question": "My car got...", "type": "input_rewrite", "answer": "damaged in the parking lot", "explanation": "La risposta corretta è \"damaged in the parking lot\". Passivo con 'get' per un evento inaspettato." },
                { "prompt": "People think that he has left the country.", "question": "He is thought...", "type": "input_rewrite", "answer": "to have left the country", "explanation": "La risposta corretta è \"to have left the country\". Passivo con infinito perfetto per un'azione precedente." },
                { "prompt": "They advised us to take a break.", "question": "We were advised...", "type": "input_rewrite", "answer": "to take a break", "explanation": "La risposta corretta è \"to take a break\". Passivo con infinito." },
                { "prompt": "They say that there are many issues.", "question": "There are said...", "type": "input_rewrite", "answer": "to be many issues", "explanation": "La risposta corretta è \"to be many issues\". Passivo impersonale con 'there'." },
                { "prompt": "The company announced the new policy yesterday.", "question": "The new policy was...", "type": "input_rewrite", "answer": "announced yesterday", "explanation": "La risposta corretta è \"announced yesterday\". Past Simple Passivo." },
                { "prompt": "The children need to feed the pets.", "question": "The pets need...", "type": "input_rewrite", "answer": "feeding", "explanation": "La risposta corretta è \"feeding\". Gerundio con significato passivo dopo 'need'." },
                { "prompt": "Someone has stolen my wallet.", "question": "My wallet has been...", "type": "input_rewrite", "answer": "stolen", "explanation": "La risposta corretta è \"stolen\". Present Perfect Passivo." },
                { "prompt": "People expect him to win the election.", "question": "He is expected...", "type": "input_rewrite", "answer": "to win the election", "explanation": "La risposta corretta è \"to win the election\". Passivo con infinito." },
                { "prompt": "They say that the treasure was hidden long ago.", "question": "The treasure is said...", "type": "input_rewrite", "answer": "to have been hidden long ago", "explanation": "La risposta corretta è \"to have been hidden long ago\". Passivo con infinito perfetto passivo per azione precedente." },
                { "prompt": "They are discussing the new proposal.", "question": "The new proposal is being...", "type": "input_rewrite", "answer": "discussed", "explanation": "La risposta corretta è \"discussed\". Present Continuous Passivo." },
                { "prompt": "Someone told me to wait outside.", "question": "I was told...", "type": "input_rewrite", "answer": "to wait outside", "explanation": "La risposta corretta è \"to wait outside\". Passivo con infinito." },
                { "prompt": "People consider him a great leader.", "question": "He is considered...", "type": "input_rewrite", "answer": "a great leader", "explanation": "La risposta corretta è \"a great leader\". Passivo con complemento del soggetto." }
            ]
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const exerciseDataScript = document.getElementById('exercise-data');
            const exerciseData = JSON.parse(exerciseDataScript.textContent);

            let currentActiveTab = 1; // Default to Fase 1

            // Function to save progress (answers)
            const saveProgress = () => {
                const answers = {};
                tabContents.forEach((tabContent, index) => {
                    const phaseNum = index + 1;
                    const inputs = tabContent.querySelectorAll('input[type="radio"], input[type="text"]');
                    inputs.forEach(input => {
                        if (input.type === 'radio' && input.checked) {
                            answers[`fase${phaseNum}_q${input.name}`] = input.value;
                        } else if (input.type === 'text') {
                            answers[`fase${phaseNum}_q${input.id}`] = input.value;
                        }
                    });
                });
                // Changed key for L3 to avoid conflicts if multiple exercises are loaded
                localStorage.setItem('passiviAvanzatiProgress', JSON.stringify(answers));
            };

            // Function to load progress (answers)
            const loadProgress = () => {
                // Changed key for L3 to avoid conflicts if multiple exercises are loaded
                const savedAnswers = JSON.parse(localStorage.getItem('passiviAvanzatiProgress')) || {};
                tabContents.forEach((tabContent, index) => {
                    const phaseNum = index + 1;
                    const inputs = tabContent.querySelectorAll('input[type="radio"], input[type="text"]');
                    inputs.forEach(input => {
                        if (input.type === 'radio' && savedAnswers[`fase${phaseNum}_q${input.name}`] === input.value) {
                            input.checked = true;
                        } else if (input.type === 'text' && savedAnswers[`fase${phaseNum}_q${input.id}`]) {
                            input.value = savedAnswers[`fase${phaseNum}_q${input.id}`];
                        }
                    });
                });
            };

            // Function to render questions for a given phase
            const renderQuestions = (phaseNum) => {
                const contentDiv = document.getElementById(`tab-content-${phaseNum}`);
                contentDiv.innerHTML = ''; // Clear previous content

                const phaseKey = `fase${phaseNum}`;
                const questions = exerciseData[phaseKey];

                if (!questions) {
                    contentDiv.innerHTML = `<p class="text-slate-500">No exercises available for Fase ${phaseNum}.</p>`;
                    return;
                }

                questions.forEach((q, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.className = 'mb-6 p-4 border border-slate-200 rounded-lg bg-white shadow-sm';

                    // Use displayNum if available, otherwise just index + 1
                    const displayNum = q.displayNum ? q.displayNum : `${index + 1}`; // Changed to just index + 1 for simplicity
                    let questionHtml = `<p class="font-semibold text-lg mb-3">${displayNum}. ${q.question}</p>`;

                    if (q.type === 'mc') {
                        q.options.forEach((choice, i) => {
                            const inputId = `fase${phaseNum}-q${index}-${i}`;
                            const value = String.fromCharCode(65 + i); // A, B, C, D
                            questionHtml += `
                                <div class="flex items-center mb-2">
                                    <input type="radio" id="${inputId}" name="q${index}" value="${value}" class="mr-2 text-indigo-600 focus:ring-indigo-500">
                                    <label for="${inputId}" class="text-slate-700">${choice}</label>
                                </div>
                            `;
                        });
                    } else if (q.type === 'input_rewrite') {
                        const inputId = `fase${phaseNum}-q${index}`;
                        questionHtml += `
                            <div class="mt-3">
                                <input type="text" id="${inputId}" class="w-full p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your answer">
                            </div>
                        `;
                    }

                    questionElement.innerHTML = questionHtml;
                    contentDiv.appendChild(questionElement);
                });

                // Add a submit button for each phase
                const submitButton = document.createElement('button');
                submitButton.textContent = 'Check Answers';
                submitButton.className = 'mt-6 px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md';
                submitButton.onclick = () => checkAnswers(phaseNum);
                contentDiv.appendChild(submitButton);

                // Add a clear answers button
                const clearButton = document.createElement('button');
                clearButton.textContent = 'Clear Answers';
                clearButton.className = 'mt-6 ml-4 px-6 py-3 bg-slate-400 text-white font-bold rounded-lg hover:bg-slate-500 transition-colors duration-300 shadow-md';
                clearButton.onclick = () => clearAnswers(phaseNum);
                contentDiv.appendChild(clearButton);

                loadProgress(); // Load saved answers after rendering questions
            };

            // Function to check answers and provide feedback
            const checkAnswers = (phaseNum) => {
                const contentDiv = document.getElementById(`tab-content-${phaseNum}`);
                const questions = exerciseData[`fase${phaseNum}`];

                questions.forEach((q, index) => {
                    const questionElement = contentDiv.children[index]; // Get the specific question div
                    let isCorrect = false;
                    let userAnswer = '';

                    if (q.type === 'mc') {
                        const selectedInput = questionElement.querySelector(`input[name="q${index}"]:checked`);
                        if (selectedInput) {
                            userAnswer = selectedInput.value;
                            console.log(`Question ${index}: User answer: ${userAnswer}, Correct answer: ${q.answer}`);
                            // Corrected logic: Compare the value ('A', 'B', etc.) with the answer from JSON
                            isCorrect = (userAnswer.toUpperCase() === q.answer.toUpperCase());
                        }
                    } else if (q.type === 'input_rewrite') {
                        const inputField = questionElement.querySelector(`#fase${phaseNum}-q${index}`);
                        if (inputField) {
                            userAnswer = inputField.value.trim();
                            // Case-insensitive and whitespace-insensitive comparison
                            isCorrect = (userAnswer.toLowerCase() === q.answer.toLowerCase().trim());
                        }
                    }

                    // Remove previous feedback classes
                    questionElement.classList.remove('feedback-correct', 'feedback-incorrect');

                    // Add new feedback class
                    if (isCorrect) {
                        questionElement.classList.add('feedback-correct');
                    } else {
                        questionElement.classList.add('feedback-incorrect');
                    }

                    // Display explanation
                    let explanationElement = questionElement.querySelector('.explanation');
                    if (!explanationElement) {
                        explanationElement = document.createElement('p');
                        explanationElement.className = 'explanation mt-3 text-sm italic text-slate-600';
                        questionElement.appendChild(explanationElement);
                    }
                    explanationElement.innerHTML = `<strong>Spiegazione:</strong> ${q.explanation}`;
                });
                saveProgress(); // Save answers after checking
            };

            // Function to clear answers for a given phase
            const clearAnswers = (phaseNum) => {
                const contentDiv = document.getElementById(`tab-content-${phaseNum}`);
                const inputs = contentDiv.querySelectorAll('input[type="radio"], input[type="text"]');
                inputs.forEach(input => {
                    if (input.type === 'radio') {
                        input.checked = false;
                    } else if (input.type === 'text') {
                        input.value = '';
                    }
                });

                // Remove feedback classes and explanations
                const questionElements = contentDiv.querySelectorAll('.mb-6');
                questionElements.forEach(qElement => {
                    qElement.classList.remove('feedback-correct', 'feedback-incorrect');
                    const explanationElement = qElement.querySelector('.explanation');
                    if (explanationElement) {
                        explanationElement.remove();
                    }
                });
                saveProgress(); // Clear saved answers
            };


            // Tab switching logic
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabToActivate = parseInt(button.dataset.tab);

                    // Deactivate current tab
                    document.getElementById(`tab-btn-${currentActiveTab}`).classList.remove('tab-active');
                    document.getElementById(`tab-btn-${currentActiveTab}`).classList.add('tab-inactive');
                    document.getElementById(`tab-content-${currentActiveTab}`).classList.add('hidden');

                    // Activate new tab
                    button.classList.remove('tab-inactive');
                    button.classList.add('tab-active');
                    document.getElementById(`tab-content-${tabToActivate}`).classList.remove('hidden');

                    currentActiveTab = tabToActivate;
                    renderQuestions(currentActiveTab); // Render questions for the newly active tab
                });
            });

            // Initial render of the first tab
            renderQuestions(currentActiveTab);
        });
    </script>
</body>
</html>
