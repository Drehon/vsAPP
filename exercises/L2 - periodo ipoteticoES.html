<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esercizi Pratici: Il Periodo Ipotetico</title>
    <link href="../src/style.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* slate-200 */
        }
        .tab-active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom-color: transparent;
            color: #475569; /* slate-600 */
        }
        .feedback-correct {
            background-color: #dcfce7; /* green-100 */
            border-left-color: #22c55e; /* green-500 */
            color: #15803d; /* green-700 */
        }
        .feedback-incorrect {
            background-color: #fee2e2; /* red-100 */
            border-left-color: #ef4444; /* red-500 */
            color: #b91c1c; /* red-700 */
        }
        .btn-correct {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        .btn-incorrect {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        .btn-neutral {
             background-color: #f1f5f9; /* slate-100 */
             border-color: #cbd5e1; /* slate-300 */
             color: #334155; /* slate-700 */
        }
        .btn-neutral:hover {
            background-color: #e2e8f0; /* slate-200 */
        }
    </style>
</head>
<body class="text-slate-700">

    <div class="container mx-auto p-6 md:p-10 max-w-7xl">

        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <header class="p-6">
                <h1 class="text-3xl font-bold text-slate-900">Esercizi Pratici: Il Periodo Ipotetico</h1>
                <p class="text-lg text-slate-600">Metti in pratica la teoria con esercizi mirati.</p>
            </header>
            <div class="p-6 border-t border-slate-200 bg-slate-50 text-sm text-slate-600 space-y-3">
                <h3 class="font-semibold text-slate-800">Come usare questa pagina:</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li><strong>Salvataggio Automatico:</strong> I tuoi progressi (risposte e note) vengono salvati automaticamente nel browser.</li>
                    <li><strong>Carica JSON:</strong> Usa questo pulsante per caricare un file di progressi salvato in precedenza.</li>
                    <li><strong>Salva e Scarica JSON:</strong> Clicca qui per scaricare un file <code>.json</code> con tutte le tue risposte e note. **Importante:** questa azione cancellerà i dati salvati nel browser, permettendoti di ricominciare. È la funzione da usare per "consegnare" il lavoro.</li>
                    <li><strong>Azzera Test:</strong> Rimuove tutti i progressi salvati nel browser e ripristina gli esercizi.</li>
                </ul>
            </div>
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-100 flex flex-wrap gap-4 justify-center items-center">
                <button id="save-btn" class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Salva Progressi</button>
                <button id="load-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Carica Progressi</button>
                <button id="reset-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Azzera Test</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Tabs -->
            <div class="border-b border-slate-200">
                <nav class="flex space-x-6 px-6" aria-label="Tabs">
                    <button id="tab-btn-1" class="tab-btn py-4 px-1 text-sm font-medium tab-active">Fase 1: Comprensione</button>
                    <button id="tab-btn-2" class="tab-btn py-4 px-1 text-sm font-medium tab-inactive">Fase 2: Riconoscimento</button>
                    <button id="tab-btn-3" class="tab-btn py-4 px-1 text-sm font-medium tab-inactive">Fase 3: Produzione</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6 md:p-8">
                <div id="tab-content-1" class="tab-content"></div>
                <div id="tab-content-2" class="tab-content hidden"></div>
                <div id="tab-content-3" class="tab-content hidden"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const exercises = {
                fase1: [
                    { question: "If I <b><u>will have</u></b> time, I will call you.", answer: false, explanation: "Nella if-clause di tipo 1, si usa il Simple Present. Corretta: <i>If I <b>have</b>...</i>" },
                    { question: "If I were you, I <b><u>would accept</u></b> the offer.", answer: true, explanation: "Corretto. Periodo ipotetico di tipo 2." },
                    { question: "If she had studied, she <b><u>would pass</u></b> the exam.", answer: false, explanation: "Periodo ipotetico di tipo 3. Corretta: <i>...she <b>would have passed</b>...</i>" },
                ],
                fase2: [
                    { question: "If I ______ you, I would apologize.", options: ["am", "was", "were", "be"], answer: "were", explanation: "Nel periodo ipotetico di tipo 2, si usa 'were' per tutte le persone." },
                    { question: "If you ______ me, I would have helped you.", options: ["had told", "told", "tell", "would tell"], answer: "had told", explanation: "Nel periodo ipotetico di tipo 3, la if-clause è al Past Perfect." },
                    { question: "We will go to the beach if the weather ______ nice.", options: ["will be", "is", "was", "be"], answer: "is", explanation: "Nel periodo ipotetico di tipo 1, la if-clause è al Simple Present." },
                ],
                fase3: [
                    { prompt: "I didn't have your number, so I didn't call you.", question: "If I had had your number...", answer: "I would have called you", explanation: "Periodo ipotetico di tipo 3." },
                    { prompt: "I am not rich, so I don't buy a Ferrari.", question: "If I were rich...", answer: "I would buy a Ferrari", explanation: "Periodo ipotetico di tipo 2." },
                    { prompt: "I might see him tomorrow. I'll give him the message.", question: "If I see him tomorrow...", answer: "I will give him the message", explanation: "Periodo ipotetico di tipo 1." },
                ]
            };

            let appState;
            const lessonId = 'L2 - periodo ipoteticoES.html';

            function initializeState() {
                const defaultState = {
                    fase1: { answers: Array(exercises.fase1.length).fill(null).map(() => ({ userAnswer: null, isCorrect: null, note: "" })) },
                    fase2: { answers: Array(exercises.fase2.length).fill(null).map(() => ({ userAnswer: null, isCorrect: null, note: "" })) },
                    fase3: { answers: Array(exercises.fase3.length).fill(null).map(() => ({ userAnswer: null, isCorrect: null, note: "" })) },
                    currentQuestion: { fase1: 0, fase2: 0, fase3: 0 }
                };
                appState = defaultState;
                loadState(); // Carica lo stato all'avvio
            }

            function saveState() {
                try {
                    localStorage.setItem(lessonId, JSON.stringify(appState));
                } catch (e) {
                    console.error("Could not save state to localStorage", e);
                }
            }

            function loadState() {
                try {
                    const savedState = localStorage.getItem(lessonId);
                    if (savedState) {
                        appState = JSON.parse(savedState);
                        // Make sure the loaded state has the correct structure
                        if (!appState.fase1 || !appState.fase2 || !appState.fase3) {
                           console.warn("Incompatible saved state found, resetting.");
                           initializeState();
                        }
                    } else {
                        initializeState();
                    }
                } catch (e) {
                    console.error("Could not load state from localStorage", e);
                    initializeState();
                }
            }

            function createScoreboard(fase, container) {
                const total = exercises[fase].length;
                const current = appState.currentQuestion[fase] + 1;
                const correct = appState[fase].answers.filter(a => a && a.isCorrect).length;
                const answered = appState[fase].answers.filter(a => a && a.userAnswer !== null).length;

                const scoreboard = document.createElement('div');
                scoreboard.className = 'flex justify-between text-sm text-slate-500 mb-4 pb-4 border-b border-slate-200';
                scoreboard.innerHTML = `
                    <span>Domanda: <strong>${current}/${total}</strong></span>
                    <span>Corrette: <strong>${correct}/${answered}</strong></span>
                `;
                container.prepend(scoreboard);
            }

            function createNotesArea(fase, index, container) {
                 const notesArea = document.createElement('div');
                 notesArea.className = 'mt-4';
                 notesArea.innerHTML = `
                    <label for="notes-${fase}-${index}" class="block text-sm font-medium text-slate-600">Note:</label>
                    <textarea id="notes-${fase}-${index}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="3">${appState[fase].answers[index].note || ''}</textarea>
                 `;
                 container.appendChild(notesArea);

                 const textarea = document.getElementById(`notes-${fase}-${index}`);
                 textarea.addEventListener('keyup', () => {
                     appState[fase].answers[index].note = textarea.value;
                     saveState();
                 });
                 return textarea;
            }

            function createFeedbackArea(fase, index, container, isCorrect, explanation) {
                const feedbackEl = document.createElement('div');
                feedbackEl.className = 'mt-4 p-4 border-l-4 rounded-r-md';
                feedbackEl.classList.add(isCorrect ? 'feedback-correct' : 'feedback-incorrect');

                let markCorrectBtn = '';
                if (!isCorrect) {
                    markCorrectBtn = `<button class="mark-correct-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-800 font-bold py-1 px-2 rounded-lg ml-4" data-fase="${fase}" data-index="${index}">Segna come Corretta</button>`;
                }

                feedbackEl.innerHTML = explanation + markCorrectBtn;
                container.appendChild(feedbackEl);

                if (!isCorrect) {
                    feedbackEl.querySelector('.mark-correct-btn').addEventListener('click', (e) => {
                        const { fase, index } = e.target.dataset;
                        appState[fase].answers[parseInt(index)].isCorrect = true;
                        saveState();
                        rerenderAll();
                    });
                }
            }

            function renderFase1() {
                const fase = 'fase1';
                const index = appState.currentQuestion.fase1;
                const container = document.getElementById('tab-content-1');
                const ex = exercises[fase][index];
                const answerState = appState[fase].answers[index];

                container.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg text-slate-600">La seguente frase è grammaticalmente corretta?</p>
                        <div class="p-4 bg-slate-100 rounded-lg text-xl text-center font-semibold text-slate-800">${ex.question}</div>
                        <div class="flex justify-center space-x-4 pt-4">
                            <button class="fase1-btn border-2 font-bold py-2 px-8 rounded-lg transition-colors" data-answer="true">Vero</button>
                            <button class="fase1-btn border-2 font-bold py-2 px-8 rounded-lg transition-colors" data-answer="false">Falso</button>
                        </div>
                        <div class="feedback-container"></div>
                        <div class="text-center pt-2">
                            <button id="next-fase1" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Prossimo</button>
                        </div>
                    </div>
                `;

                createScoreboard(fase, container);
                const notesTextarea = createNotesArea(fase, index, container.querySelector('.space-y-4'));

                if (answerState.userAnswer !== null) {
                    notesTextarea.disabled = true;
                    document.querySelectorAll('.fase1-btn').forEach(b => {
                        b.disabled = true;
                        if (String(answerState.userAnswer) === b.dataset.answer && !answerState.isCorrect) b.classList.add('btn-incorrect');
                        if (String(ex.answer) === b.dataset.answer) b.classList.add('btn-correct');
                        else if (String(answerState.userAnswer) !== b.dataset.answer) b.classList.add('opacity-50');
                    });
                    createFeedbackArea(fase, index, container.querySelector('.feedback-container'), answerState.isCorrect, ex.explanation);
                } else {
                    addFase1Listeners();
                }

                document.getElementById('next-fase1').addEventListener('click', () => {
                    appState.currentQuestion.fase1 = (appState.currentQuestion.fase1 + 1) % exercises.fase1.length;
                    saveState();
                    renderFase1();
                });
            }

            function addFase1Listeners() {
                document.querySelectorAll('.fase1-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userAnswer = e.target.dataset.answer === 'true';
                        const fase = 'fase1';
                        const index = appState.currentQuestion.fase1;
                        const correctAnswer = exercises[fase][index].answer;

                        appState[fase].answers[index].userAnswer = userAnswer;
                        appState[fase].answers[index].isCorrect = userAnswer === correctAnswer;
                        saveState();
                        renderFase1();
                    });
                });
                document.querySelectorAll('.fase1-btn').forEach(b => b.classList.add('btn-neutral'));
            }

            function renderFase2() {
                const fase = 'fase2';
                const index = appState.currentQuestion.fase2;
                const container = document.getElementById('tab-content-2');
                const ex = exercises[fase][index];
                const answerState = appState[fase].answers[index];

                container.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg text-slate-600">Scegli l'opzione corretta per completare la frase.</p>
                        <div class="p-4 bg-slate-100 rounded-lg text-xl text-center font-semibold text-slate-800">${ex.question}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                            ${ex.options.map(opt => `<button class="fase2-btn border-2 font-bold py-3 px-6 rounded-lg transition-colors" data-answer="${opt}">${opt}</button>`).join('')}
                        </div>
                        <div class="feedback-container"></div>
                        <div class="text-center pt-2">
                            <button id="next-fase2" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Prossimo</button>
                        </div>
                    </div>
                `;

                createScoreboard(fase, container);
                const notesTextarea = createNotesArea(fase, index, container.querySelector('.space-y-4'));

                if (answerState.userAnswer !== null) {
                    notesTextarea.disabled = true;
                    document.querySelectorAll('.fase2-btn').forEach(b => {
                        b.disabled = true;
                        if (b.dataset.answer === answerState.userAnswer && !answerState.isCorrect) b.classList.add('btn-incorrect');
                        if (b.dataset.answer === ex.answer) b.classList.add('btn-correct');
                        else if (b.dataset.answer !== answerState.userAnswer) b.classList.add('opacity-50');
                    });
                    createFeedbackArea(fase, index, container.querySelector('.feedback-container'), answerState.isCorrect, ex.explanation);
                } else {
                    addFase2Listeners();
                }

                document.getElementById('next-fase2').addEventListener('click', () => {
                    appState.currentQuestion.fase2 = (appState.currentQuestion.fase2 + 1) % exercises.fase2.length;
                    saveState();
                    renderFase2();
                });
            }

            function addFase2Listeners() {
                document.querySelectorAll('.fase2-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userAnswer = e.target.dataset.answer;
                        const fase = 'fase2';
                        const index = appState.currentQuestion.fase2;
                        const ex = exercises[fase][index];

                        appState[fase].answers[index].userAnswer = userAnswer;
                        appState[fase].answers[index].isCorrect = userAnswer === ex.answer;
                        saveState();
                        renderFase2();
                    });
                });
                document.querySelectorAll('.fase2-btn').forEach(b => b.classList.add('btn-neutral'));
            }

            function renderFase3() {
                const fase = 'fase3';
                const index = appState.currentQuestion.fase3;
                const container = document.getElementById('tab-content-3');
                const ex = exercises[fase][index];
                const answerState = appState[fase].answers[index];

                container.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg text-slate-600">Riscrivi o completa la frase usando una struttura con il congiuntivo.</p>
                        <div class="p-4 bg-slate-100 rounded-lg space-y-2">
                            <p class="text-slate-600"><strong>Frase di partenza:</strong> "${ex.prompt}"</p>
                            <p class="text-xl font-semibold text-slate-800">${ex.question} <input type="text" id="fase3-input" class="font-normal text-base border-b-2 border-slate-300 focus:border-indigo-500 outline-none w-1/2 bg-slate-100"></p>
                        </div>
                        <div class="flex justify-center space-x-4 pt-4">
                            <button id="check-fase3" class="border-2 font-bold py-2 px-8 rounded-lg transition-colors">Controlla</button>
                        </div>
                        <div class="feedback-container"></div>
                        <div class="text-center pt-2">
                            <button id="next-fase3" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Prossimo</button>
                        </div>
                    </div>
                `;

                createScoreboard(fase, container);
                const notesTextarea = createNotesArea(fase, index, container.querySelector('.space-y-4'));
                const inputEl = document.getElementById('fase3-input');
                const checkBtn = document.getElementById('check-fase3');

                if (answerState.userAnswer !== null) {
                    notesTextarea.disabled = true;
                    inputEl.disabled = true;
                    inputEl.value = answerState.userAnswer;
                    checkBtn.disabled = true;
                    checkBtn.classList.add('opacity-50');
                    inputEl.classList.remove('border-slate-300');
                    inputEl.classList.add(answerState.isCorrect ? 'border-green-500' : 'border-red-500');
                    createFeedbackArea(fase, index, container.querySelector('.feedback-container'), answerState.isCorrect, `<strong>Risposta corretta:</strong> ${ex.answer}<br>${ex.explanation}`);
                } else {
                    addFase3Listeners();
                }

                document.getElementById('next-fase3').addEventListener('click', () => {
                    appState.currentQuestion.fase3 = (appState.currentQuestion.fase3 + 1) % exercises.fase3.length;
                    saveState();
                    renderFase3();
                });
            }

            function addFase3Listeners() {
                const checkBtn = document.getElementById('check-fase3');
                const inputEl = document.getElementById('fase3-input');

                checkBtn.addEventListener('click', () => {
                    const userAnswer = inputEl.value.trim();
                    const fase = 'fase3';
                    const index = appState.currentQuestion.fase3;
                    const ex = exercises[fase][index];
                    const correctAnswer = ex.answer.trim();

                    appState[fase].answers[index].userAnswer = userAnswer;
                    appState[fase].answers[index].isCorrect = userAnswer.toLowerCase().replace(/[.,]/g, '') === correctAnswer.toLowerCase().replace(/[.,]/g, '');
                    saveState();
                    renderFase3();
                });

                inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { checkBtn.click(); } });
                checkBtn.classList.add('btn-neutral');
            }

            function rerenderAll() {
                renderFase1();
                renderFase2();
                renderFase3();
                saveState();
            }

            document.getElementById('save-btn').addEventListener('click', async () => {
                const result = await window.api.saveProgress(lessonId, appState);
                if (result.success) {
                    alert(`Progressi salvati in: ${result.path}`);
                } else {
                    alert(`Errore nel salvataggio: ${result.error}`);
                }
            });

            document.getElementById('load-btn').addEventListener('click', async () => {
                const saves = await window.api.loadProgress(lessonId);
                if (saves.length === 0) {
                    alert('Nessun salvataggio trovato per questa lezione.');
                    return;
                }

                const choices = saves.map((s, i) => `${i + 1}: ${s.name}`).join('\n');
                const choice = prompt(`Scegli un salvataggio:\n${choices}`);
                const index = parseInt(choice) - 1;

                if (!isNaN(index) && index >= 0 && index < saves.length) {
                    const data = await window.api.getLessonData(saves[index].path);
                    if (data) {
                        appState = data;
                        rerenderAll();
                        alert('Salvataggio caricato con successo.');
                    } else {
                        alert('Errore nel caricamento del file di salvataggio.');
                    }
                }
            });

            document.getElementById('reset-btn').addEventListener('click', () => {
                if (confirm("Sei sicuro di voler azzerare tutti i progressi? L'azione è irreversibile.")) {
                    initializeState();
                    rerenderAll();
                }
            });

            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabNum = btn.id.split('-')[2];
                    tabBtns.forEach(b => b.classList.replace('tab-active', 'tab-inactive'));
                    btn.classList.replace('tab-inactive', 'tab-active');
                    tabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(`tab-content-${tabNum}`).classList.remove('hidden');
                });
            });

            initializeState();
            rerenderAll();
        });
    </script>

</body>
</html>
