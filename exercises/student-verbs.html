<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Verb Diagnostic for TOEIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-inactive { border-bottom-color: transparent; color: #475569; }
        .question-block { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .inline-select, .review-select {
            display: inline-block;
            background-color: #f0f4f8;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.1rem 2rem 0.1rem 0.4rem;
            color: #1e293b;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.25rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }
        .review-select:disabled { background-image: none; }
        .correct-answer { border-color: #10b981 !important; background-color: rgba(16, 185, 129, 0.1) !important; }
        .incorrect-answer { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .mc-options-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-left: 0.25rem;
        }
        .mc-option-item {
            background-color: #e2e8f0;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .mc-option-item.correct {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            font-weight: 600;
        }
        .mc-option-item.incorrect-selected {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Verb System Diagnostic</h1>
            <p class="text-slate-600 mt-2">An interactive assessment for TOEIC Preparation (B2-C1 Level)</p>
        </header>
        
        <div id="intro-view" class="bg-white p-6 rounded-lg shadow-md mb-8 prose max-w-none">
            <h2 class="text-slate-900">Instructions and Test Overview</h2>
            <p>This diagnostic test is designed to identify specific strengths and weaknesses in your understanding of the English verb system. It is not about getting a simple score, but about pinpointing the exact grammatical rules you need to focus on.</p>
            <p>The test is divided into three blocks. As a gross estimate, each block should take approximately 30 minutes if uninterrupted. The questions are challenging and often test several grammar points at once to simulate the cognitive demands of a real proficiency test.</p>
            <ul>
                <li>Complete and submit each block independently. Your progress is saved automatically.</li>
                <li>Use the provided "Notes" areas to jot down your thought process. These notes will not be graded automatically but can be downloaded and are invaluable for analysis.</li>
            </ul>
            <p class="mt-4">
                You can **Save** your current test progress and notes at any time by clicking "Save Progress (JSON)". This will download a JSON file to your device.
                To **Load** a previously saved test or continue from where you left off, click "Load Progress (JSON)" and select your saved JSON file. This will overwrite any current unsaved progress.
            </p>
            <div class="mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                <button type="button" id="save-progress-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Save Progress (JSON)</button>
                <button type="button" id="load-progress-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Load Progress (JSON)</button>
                <input type="file" id="load-file-input" accept=".json" class="hidden">
            </div>
            <p class="mt-4">After submitting a block, you will enter "Review Mode" to see your results directly on the test. You can then proceed to the "Diagnostics" page for a performance breakdown.</p>
            <p>Good luck. Begin with Block A when you are ready.</p>
        </div>

        <div>
            <div id="test-container" class="bg-white p-6 rounded-lg shadow-md">
                <div id="test-view">
                    <div class="mb-6 border-b border-slate-200">
                        <nav class="flex space-x-6" aria-label="Tabs">
                            <button id="tab-block-1" class="tab-btn py-3 px-1 text-sm font-medium tab-active">Block A</button>
                            <button id="tab-block-2" class="tab-btn py-3 px-1 text-sm font-medium tab-inactive">Block B</button>
                            <button id="tab-block-3" class="tab-btn py-3 px-1 text-sm font-medium tab-inactive">Block C</button>
                        </nav>
                    </div>
                    <form id="diagnostic-form">
                        <div id="questions-container"></div>
                        <div id="submission-area" class="mt-8 text-center"></div>
                    </form>
                </div>
            </div>

            <div id="diagnostics-view" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-900">Performance Diagnostics</h2>
                    <button id="back-to-review-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-md">
                        &larr; Back to Test Review
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="mb-6 border-b border-slate-200">
                        <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                            <button id="diag-tab-overall" data-tab="overall" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Overall</button>
                            <button id="diag-tab-block-a" data-tab="block-a" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Block A</button>
                            <button id="diag-tab-block-b" data-tab="block-b" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Block B</button>
                            <button id="diag-tab-block-c" data-tab="block-c" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Block C</button>
                        </nav>
                    </div>
                    <div id="diag-content-overall" class="diag-content hidden">
                        <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="overallChart"></canvas> </div>
                    </div>
                    <div id="diag-content-block-a" class="diag-content hidden">
                         <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="blockAChart"></canvas> </div>
                    </div>
                    <div id="diag-content-block-b" class="diag-content hidden">
                         <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="blockBChart"></canvas> </div>
                    </div>
                    <div id="diag-content-block-c" class="diag-content hidden">
                         <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="blockCChart"></canvas> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: DATA ---
        Chart.register(ChartDataLabels);

        const testData = [
            // Block A
            { block: 1, displayNum: 'A1', section: 'A: Contextual Multiple-Choice', sectionExplanation: 'Read the following business email. For questions A1-A5, choose the best word or phrase to fill each gap from the dropdown menus.', type: 'mc', category: 'Tenses', question: `I ______ the draft of the quarterly report you sent over this morning, and it looks solid.`, choices: ['reviewed', 'have just reviewed', 'had reviewed', 'was reviewing'], answer: 'B', explanation: `**Present Perfect vs. Simple Past:** The phrase "this morning" and the ongoing relevance to the current task make the present perfect ('have just reviewed') the most appropriate choice to indicate a recent past action with present results.` },
            { block: 1, displayNum: 'A2', section: 'A: Contextual Multiple-Choice', type: 'mc', category: 'Passive Voice', question: `According to the project timeline, the complete report ______ to the board by this Friday.`, choices: ['will submit', 'is submitting', 'will have submitted', 'is to be submitted'], answer: 'D', explanation: `**Passive Voice with 'be to':** The structure 'is to be submitted' is a formal way of expressing an official plan or obligation, common in business contexts. It combines the passive voice with the semi-modal 'be to'.` },
            { block: 1, displayNum: 'A3', section: 'A: Contextual Multiple-Choice', type: 'mc', category: 'Modals', question: `He said the delay ______ by an unexpected server update last night.`, choices: ['must be', 'should have been', 'might have been caused', 'had to be causing'], answer: 'C', explanation: `**Modal of Past Possibility/Speculation:** 'might have been caused' correctly expresses a possibility about a past event. It combines a modal ('might'), the perfect aspect ('have been'), and the passive voice ('been caused').` },
            { block: 1, displayNum: 'A4', section: 'A: Contextual Multiple-Choice', type: 'mc', category: 'Subject-Verb Agreement', question: `Neither Jean-Paul nor his team members ______ a specific time for delivery, but they expect it will be today.`, choices: ['has provided', 'have provided', 'is providing', 'are providing'], answer: 'B', explanation: `**Subject-Verb Agreement (Complex Subject):** With "Neither... nor...", the verb agrees with the subject closest to it. "members" is plural, requiring the plural verb 'have provided'.` },
            { block: 1, displayNum: 'A5', section: 'A: Contextual Multiple-Choice', type: 'mc', category: 'Causatives', question: `Let's plan to have the final version of the report ______ by a professional proofreader before the Friday deadline.`, choices: ['check', 'to be checked', 'checked', 'getting checked'], answer: 'C', explanation: `**Causative Passive ('have something done'):** The structure 'have [object][past participle]' is used to arrange for someone else to perform a service. The correct form is 'have the report checked'.` },
            { 
                block: 1, displayNum: 'A6', section: 'B: Error Identification and Correction', sectionExplanation: 'The following paragraph contains six errors related to verb usage. <br>Identify each incorrect verb form and write the correction in the corresponding box.', type: 'paragraph_error_id', category: 'Mixed Verbs',
                question: `<div class="p-4 border-l-4 border-slate-200 bg-slate-50">The critical issue with the new logistics software <b>rised</b> during yesterday's peak hours, which <b>has been causing</b> significant delays since. The operations manager, who was visibly frustrated, demanded that a full incident report <b>was prepared</b> immediately and insisted that the IT department <b>solves</b> the problem by the end of the day. If the vendor <b>would have disclosed</b> the system's limitations earlier, we <b>wouldn't face</b> this crisis now.</div>`,
                parts: [
                    { label: 'rised', answer: 'arose', explanation: `**Irregular Verb & Confused Pair (rise/raise/arise):** 'arose' (past of arise, meaning 'emerged') is the correct intransitive verb here. 'Rised' is not a word.` },
                    { label: 'has been causing', answer: 'has caused', explanation: `**Tense Nuance (Present Perfect vs. PPC):** The focus is on the result of the action (the delays that exist now), not the ongoing duration. The simple present perfect ('has caused') is more appropriate.` },
                    { label: 'was prepared', answer: 'be prepared', explanation: `**Subjunctive Mood (Passive):** After a verb of demand ('demanded that...'), the subjunctive mood (base form 'be') is required. In passive, this is 'be prepared'.` },
                    { label: 'solves', answer: 'solve', explanation: `**Subjunctive Mood (Active):** Following 'insisted that...', the subjunctive mood (base form 'solve') is used, not the third-person singular 'solves'.` },
                    { label: 'would have disclosed', answer: 'had disclosed', explanation: `**Third Conditional (if-clause):** The 'if'-clause of a third conditional requires the past perfect ('had' + past participle). Using 'would have' here is a common error.` },
                    { label: `wouldn't face`, answer: `wouldn't be facing`, explanation: `**Mixed Conditional (Type 3 -> 2):** This connects a past unreal condition to a present unreal result ('...now'). The result clause requires 'would' + base verb. The continuous form emphasizes the ongoing nature of the crisis.` }
                ]
            },
            { block: 1, displayNum: 'A7', section: 'C: Sentence Transformation', sectionExplanation: 'Complete the second sentence so that it has a similar meaning to the first sentence. This section tests your ability to use a variety of advanced structures. For example:<ul><li class="my-1"><b>Passive Voice:</b> Changing "The company will launch the product" to "The product will be launched by the company."</li><li class="my-1"><b>Causatives:</b> Changing "I will ask a mechanic to check my car" to "I will have my car checked."</li><li class="my-1"><b>Subjunctive:</b> Using base verbs after expressions like "I insist that he..." (e.g., "I insist that he <b>be</b> on time.")</li></ul>', type: 'input', category: 'Passive Voice', question: `The auditors will have finished their inspection by the end of the week. <br> &rarr; By the end of the week, the inspection _______________ by the auditors.`, answer: 'will have been finished', explanation: `**Future Perfect Passive:** This transforms an active future perfect sentence ('will have finished') into its passive equivalent ('will have been finished').` },
            { block: 1, displayNum: 'A8', section: 'C: Sentence Transformation', type: 'input', category: 'Subjunctive', question: `The CEO said, "We must accelerate our digital transformation strategy." <br> &rarr; The CEO _______________ digital transformation strategy be accelerated.`, answer: 'insisted that their', explanation: `**Reported Speech (Subjunctive):** This reports a statement using 'insisted', which requires a 'that'-clause with a verb in the subjunctive mood ('...strategy be accelerated').` },
            { block: 1, displayNum: 'A9', section: 'C: Sentence Transformation', type: 'input', category: 'Modals', question: `It's possible that the marketing team did not receive the final brief. <br> &rarr; The final brief _______________ by the marketing team.`, answer: 'might not have been received', explanation: `**Modal Perfect Passive:** This forms a passive construction with a modal of past possibility ('might not have' + 'been' + past participle).` },
            { block: 1, displayNum: 'A10', section: 'C: Sentence Transformation', type: 'input', category: 'Causatives', question: `I will arrange for a technician to install the new equipment next Monday. <br> &rarr; I will _______________ installed by a technician next Monday.`, answer: 'have the new equipment', explanation: `**Causative ('have something done'):** This requires changing an active sentence into the causative structure 'have' + object + past participle.` },
            { block: 1, displayNum: 'A11', section: 'C: Sentence Transformation', type: 'input', category: 'Gerunds & Infinitives', question: `"You should reconsider your decision to resign," the HR manager told him. <br> &rarr; The HR manager _______________ his decision to resign.`, answer: 'urged him to reconsider', explanation: `**Reporting Verb Pattern ('urge someone to do'):** This tests the knowledge of the specific verb pattern that follows 'urge', which is 'urge' + object + infinitive.` },
            
            // Block B
            { block: 2, displayNum: 'B1', section: 'A: Gerunds, Infinitives, and Participles', sectionExplanation: 'Complete the sentences with the correct form of the verb in brackets. This requires knowing which form follows certain verbs or is used in certain structures. For example:<ul><li class="my-1"><b>Gerund:</b> "He enjoys <b>playing</b> tennis."</li><li class="my-1"><b>Infinitive:</b> "She decided <b>to leave</b>."</li><li class="my-1"><b>Participle Clause:</b> "<b>Having finished</b> his work, he went home."</li></ul>', type: 'input', category: 'Gerunds & Infinitives', question: `On his way to the crucial meeting, he stopped _______________ (get) a coffee, which unfortunately made him late.`, answer: 'to get', explanation: `**'stop' + Infinitive:** 'stop to do something' means to interrupt one activity to do another.` },
            { block: 2, displayNum: 'B2', section: 'A: Gerunds, Infinitives, and Participles', type: 'input', category: 'Gerunds & Infinitives', question: `He vaguely remembers _______________ (mention) the potential risks during the initial planning phase, but he can't find it in the meeting minutes.`, answer: 'mentioning', explanation: `**'remember' + Gerund:** 'remember doing something' refers to having a memory of a past action.` },
            { block: 2, displayNum: 'B3', section: 'A: Gerunds, Infinitives, and Participles', type: 'input', category: 'Gerunds & Infinitives', question: `The board went on _______________ (discuss) the quarterly budget after they had finished the review of the sales performance.`, answer: 'to discuss', explanation: `**'go on' + Infinitive:** 'go on to do something' means to move to the next, different action in a sequence.` },
            { block: 2, displayNum: 'B4', section: 'A: Gerunds, Infinitives, and Participles', type: 'input', category: 'Gerunds & Infinitives', question: `We regret _______________ (inform) all applicants that the position for which they applied has now been filled.`, answer: 'to inform', explanation: `**'regret' + Infinitive:** 'regret to do something' is used to formally give bad news.` },
            { block: 2, displayNum: 'B5', section: 'A: Gerunds, Infinitives, and Participles', type: 'input', category: 'Participles', question: `_______________ (work) in international sales for over a decade, she found it easy to adapt to the new market.`, answer: 'Having worked', explanation: `**Perfect Participle Clause:** 'Having worked' is used to show that this action happened before the action in the main clause and to explain the reason for it.` },
            { block: 2, displayNum: 'B6', section: 'B: Phrasal Verbs & Structures', sectionExplanation: 'Choose the best phrasal verb or structure from the dropdown menu to complete the sentences.', type: 'mc', category: 'Phrasal Verbs', question: `After the initial plan was rejected, the team had to go back to the drawing board and ______ a completely new strategy.`, choices: ['come up with', 'get on with', 'fall back on', 'do away with'], answer: 'A', explanation: `**'come up with'**: Means to think of or create an idea or plan.` },
            { block: 2, displayNum: 'B7', section: 'B: Phrasal Verbs & Structures', type: 'mc', category: 'Phrasal Verbs', question: `We can't ______ this decision any longer; we need to inform the stakeholders by tomorrow.`, choices: ['put up', 'put off', 'put down', 'put on'], answer: 'B', explanation: `**'put off'**: Means to postpone or delay.` },
            { block: 2, displayNum: 'B8', section: 'B: Phrasal Verbs & Structures', type: 'mc', category: 'Phrasal Verbs', question: `The unexpected resignation of the project manager has ______ the entire timeline by at least two weeks.`, choices: ['brought about', 'turned down', 'set back', 'taken over'], answer: 'C', explanation: `**'set back'**: Means to delay the progress of something.` },
            { block: 2, displayNum: 'B9', section: 'B: Phrasal Verbs & Structures', type: 'mc', category: 'Phrasal Verbs', question: `Before we launch the product, we must ______ all the bugs discovered during the quality assurance phase.`, choices: ['call off', 'look after', 'get through', 'sort out'], answer: 'D', explanation: `**'sort out'**: Means to resolve a problem.` },
            { block: 2, displayNum: 'B10', section: 'B: Phrasal Verbs & Structures', type: 'mc', category: 'Phrasal Verbs', question: `I'm not sure I can ______ what he's suggesting; the data seems to contradict his main point.`, choices: ['make out', 'give in', 'stand for', 'run into'], answer: 'A', explanation: `**'make out'**: Means to understand something with difficulty.` },
            { block: 2, displayNum: 'B11', section: 'B: Phrasal Verbs & Structures', type: 'mc', category: 'Causatives', question: `Because the contract was so complex, the director got a legal expert ______ it carefully.`, choices: ['review', 'to review', 'reviewed', 'reviewing'], answer: 'B', explanation: `**Causative ('get someone to do'):** The verb 'get' in a causative sense requires the pattern 'get' + person + 'to'-infinitive.` },
            { block: 2, displayNum: 'B12', section: 'B: Phrasal Verbs & Structures', type: 'mc', category: 'Passive Voice', question: `I resent ______ what to do by people who don't understand the situation.`, choices: ['telling', 'to be told', 'being told', 'having told'], answer: 'C', explanation: `**Passive Gerund:** The verb 'resent' is followed by a gerund. To make this passive (the subject is the receiver of the action of being told), the passive gerund 'being told' is required.` },
            { block: 2, displayNum: 'B13', section: 'C: Advanced Passive and Causative Structures', sectionExplanation: 'Complete the second sentence so that it has a similar meaning to the first sentence. This section focuses on advanced passive and causative forms. For example:<ul><li class="my-1"><b>Passive with Reporting Verbs:</b> "People say he is rich" can become "He is said <b>to be</b> rich."</li><li class="my-1"><b>Passive of `make`:</b> "The boss made them work" becomes "They were made <b>to work</b>."</li></ul>', type: 'input', category: 'Passive Voice', question: `People believe that the former CEO was living in seclusion after the scandal.<br> &rarr; The former CEO is believed _______________ in seclusion after the scandal.`, answer: 'to have been living', explanation: `**Passive with Reporting Verbs:** When the reported action ('was living') is in the past relative to the reporting verb ('is believed'), the perfect infinitive ('to have been living') is required.` },
            { block: 2, displayNum: 'B14', section: 'C: Advanced Passive and Causative Structures', type: 'input', category: 'Passive Voice', question: `The manager forced the team to work overtime to meet the deadline.<br> &rarr; The team were _______________ overtime to meet the deadline.`, answer: 'made to work', explanation: `**Passive of 'make':** The active 'make someone do' becomes the passive 'be made to do', requiring the 'to'-infinitive.` },
            { block: 2, displayNum: 'B15', section: 'C: Advanced Passive and Causative Structures', type: 'input', category: 'Causatives', question: `The company is arranging for an external firm to audit its accounts.<br> &rarr; The company is having _______________ by an external firm.`, answer: 'its accounts audited', explanation: `**Causative ('have something done'):** This tests the passive causative in the present continuous tense ('is having' + object + past participle).` },
            
            // Block C
            { block: 3, displayNum: 'C1', section: 'A: Advanced Conditionals (Input)', sectionExplanation: 'Complete the sentences using the appropriate conditional forms or rewrite them as instructed. This includes inverted conditionals. For example:<ul><li class="my-1"><b>Inverted Conditional:</b> "If I had known..." can be rewritten as "<b>Had I known...</b>"</li><li class="my-1"><b>Mixed Conditional:</b> A sentence connecting a past condition to a present result, like "If I had taken that job (past), I would be rich now (present)."</li></ul>', type: 'input', category: 'Conditionals', question: `He isn't a fluent Japanese speaker, so he didn't secure the deal during his trip to Tokyo last month.<br> &rarr; If he _______________ a fluent Japanese speaker, he _______________ the deal during his trip to Tokyo last month.`, answer: `were, would have secured`, explanation: `**Mixed Conditional (Type 2 -> 3):** This connects a present/general unreal condition ('If he were...') with a past unreal result ('...he would have secured...'). The comma separates the two parts of the answer.` },
            { block: 3, displayNum: 'C2', section: 'A: Advanced Conditionals (Input)', type: 'input', category: 'Conditionals', question: `Rewrite the following sentence beginning with the word provided.<br><em>"If you should need any further assistance, please do not hesitate to contact us."</em><br> &rarr; <strong>Should</strong> _______________.`, answer: 'you need any further assistance, please do not hesitate to contact us', explanation: `**Inverted First Conditional:** A formal conditional can be inverted by starting with 'Should' + subject + base verb.` },
            { block: 3, displayNum: 'C3', section: 'A: Advanced Conditionals (Input)', type: 'input', category: 'Conditionals', question: `Identify and correct the error in the following sentence.<br><em>"If I would have known you were coming, I would have tidied up the place."</em><br> &rarr; Error: _______________`, answer: 'would have known', explanation: `**Third Conditional (if-clause):** This identifies the common error of using 'would have' in the 'if'-clause. The correct structure is the past perfect, 'had known'.` },
            { block: 3, displayNum: 'C4', section: 'B: Conditional Scenarios (Multiple Choice)', sectionExplanation: 'Choose the best option from the dropdown menu to complete the sentences.', type: 'mc', category: 'Conditionals', question: `______ aware of the potential consequences, they would never have proceeded with such a risky investment.`, choices: ['Had they been', 'If they would be', 'Should they have been', 'If they were'], answer: 'A', explanation: `**Inverted Third Conditional:** 'Had they been' is the formal, inverted form of 'If they had been', used to create the condition without using 'if'.` },
            { block: 3, displayNum: 'C5', section: 'B: Conditional Scenarios (Multiple Choice)', type: 'mc', category: 'Conditionals', question: `If the company hadn't invested heavily in R&D years ago, it ______ its market-leading position now.`, choices: ['wouldn\'t have', 'wouldn\'t have had', 'wouldn\'t be holding', 'didn\'t hold'], answer: 'C', explanation: `**Mixed Conditional (Type 3 -> 2):** Connects a past unreal condition to a present unreal result. The continuous 'be holding' emphasizes the ongoing state.` },
            { block: 3, displayNum: 'C6', section: 'C: Subjunctive Mood and Semi-Modals', sectionExplanation: 'Complete the sentences with the correct verb forms. Pay attention to:<ul><li class="my-1"><b>Subjunctive Mood:</b> Used after verbs of demand, recommendation, etc. (e.g., "They recommended that he <b>not sign</b> the contract.")</li><li class="my-1"><b>`would rather` for past:</b> Expressing preference about a past event (e.g., "I would rather you <b>had told</b> me the truth yesterday.")</li><li class="my-1"><b>Semi-modals:</b> Phrases like `be supposed to` which have modal-like meanings.</li></ul>', type: 'input', category: 'Subjunctive', question: `The board's regulations require that every new proposal _______________ (submit) for ethical review before it is approved.`, answer: 'be submitted', explanation: `**Passive Subjunctive:** After 'require that...', the subjunctive is used. In passive voice, this is 'be' + past participle.` },
            { block: 3, displayNum: 'C7', section: 'C: Subjunctive Mood and Semi-Modals', type: 'input', category: 'Subjunctive', question: `The CEO insisted that the lead negotiator _______________ (be) present at the meeting and that he _______________ (not / be) late.`, answer: 'be, not be', explanation: `**Active and Negative Subjunctive:** After 'insisted that...', the subjunctive requires the base form 'be' and the negative 'not be'. The comma separates the two parts of the answer.` },
            { block: 3, displayNum: 'C8', section: 'C: Subjunctive Mood and Semi-Modals', type: 'input', category: 'Modals', question: `He _______________ (suppose / be) monitoring the network traffic, but a system log shows he was inactive for over an hour before the breach occurred.`, answer: 'was supposed to be', explanation: `**Past Form of Semi-Modal:** This tests the past tense of the semi-modal 'be supposed to', which is 'was/were supposed to'.` },
            { block: 3, displayNum: 'C9', section: 'C: Subjunctive Mood and Semi-Modals', type: 'input', category: 'Subjunctive', question: `The legal team recommended that the contract _______________ (re-examine) by an external consultant before being signed.`, answer: 'be re-examined', explanation: `**Passive Subjunctive:** After 'recommended that...', the subjunctive is used. The passive form is 'be' + past participle.` },
            { block: 3, displayNum: 'C10', section: 'C: Subjunctive Mood and Semi-Modals', type: 'input', category: 'Modals', question: `I would rather you _______________ (not / mention) the merger during the all-staff meeting yesterday, as the details were not yet finalized.`, answer: `hadn't mentioned`, explanation: `**'would rather' + Past Perfect:** When 'would rather' is followed by a subject and refers to a past action ('yesterday'), the past perfect is used to express regret.` }
        ];
        // --- END: DATA ---

        // --- START: STATE & DOM ELEMENTS ---
        let currentBlock = 1;
        let chartInstances = {};
        let testState = JSON.parse(localStorage.getItem('verbTestState')) || {
            1: { completed: false, answers: {} },
            2: { completed: false, answers: {} },
            3: { completed: false, answers: {} }
        };
        
        const testContainer = document.getElementById('test-container');
        const diagnosticsView = document.getElementById('diagnostics-view');
        const questionsContainer = document.getElementById('questions-container');
        const submissionArea = document.getElementById('submission-area');
        const form = document.getElementById('diagnostic-form');
        const tabs = document.querySelectorAll('.tab-btn');
        const diagTabs = document.querySelectorAll('.diag-tab-btn');
        const loadFileInput = document.getElementById('load-file-input'); // Get the hidden file input
        // --- END: STATE & DOM ELEMENTS ---

        // --- START: CORE RENDERING ---
        const renderQuestions = (block) => {
            questionsContainer.innerHTML = '';
            
            const blockQuestions = testData.filter(q => q.block === block);
            
            const sections = new Map();
            blockQuestions.forEach(q => {
                if (!sections.has(q.section)) sections.set(q.section, { questions: [], explanation: q.sectionExplanation });
                sections.get(q.section).questions.push(q);
            });

            for (const [sectionName, data] of sections.entries()) {
                const sectionHeader = document.createElement('h3');
                sectionHeader.className = 'text-lg font-bold text-slate-900 mt-6 mb-4 border-b border-slate-200 pb-2';
                sectionHeader.textContent = sectionName;
                questionsContainer.appendChild(sectionHeader);
                
                if (data.explanation) {
                    const explanationP = document.createElement('div'); // Changed to div to allow ul
                    explanationP.className = 'text-sm text-slate-600 mb-4 prose prose-sm max-w-none';
                    explanationP.innerHTML = data.explanation;
                    questionsContainer.appendChild(explanationP);
                }

                if (sectionName === 'A: Contextual Multiple-Choice' && block === 1) {
                    const emailContainer = document.createElement('div');
                    emailContainer.className = 'p-4 border border-slate-200 rounded-lg mb-6 bg-slate-50';
                    emailContainer.innerHTML = `
                        <p class="font-bold text-slate-800">To: Sarah Jenkins</p>
                        <p class="font-bold text-slate-800">From: Mark Gibbons</p>
                        <p class="mb-4 font-bold text-slate-800">Subject: Urgent: Quarterly Report Figures</p>
                        <div id="q-wrapper-A1" class="text-slate-700 leading-relaxed">Hi Sarah,<br><br>I ${createDropdown('A1', testData.find(q => q.displayNum === 'A1').choices)} the draft of the quarterly report you sent over this morning, and it looks solid. ${createNotesHTML('A1')}</div>
                        <div id="q-wrapper-A2" class="text-slate-700 leading-relaxed mt-2">However, a few of the final sales figures from the European division are missing. According to the project timeline, the complete report ${createDropdown('A2', testData.find(q => q.displayNum === 'A2').choices)} to the board by this Friday. We need to ensure all data is included. ${createNotesHTML('A2')}</div>
                        <div id="q-wrapper-A3" class="text-slate-700 leading-relaxed mt-2">I spoke to Jean-Paul from the Paris office. He said the delay ${createDropdown('A3', testData.find(q => q.displayNum === 'A3').choices)} by an unexpected server update last night. ${createNotesHTML('A3')}</div>
                        <div id="q-wrapper-A4" class="text-slate-700 leading-relaxed mt-2">He assured me that the final numbers are being compiled now. Neither Jean-Paul nor his team members ${createDropdown('A4', testData.find(q => q.displayNum === 'A4').choices)}. ${createNotesHTML('A4')}</div>
                        <div id="q-wrapper-A5" class="text-slate-700 leading-relaxed mt-2">Let's plan to have the final version of the report ${createDropdown('A5', testData.find(q => q.displayNum === 'A5').choices)}. ${createNotesHTML('A5')}</div>
                        <p class="text-slate-700 mt-4">Thanks,<br>Mark</p>
                    `;
                    questionsContainer.appendChild(emailContainer);
                } else {
                    data.questions.forEach(q => {
                        const questionWrapper = document.createElement('div');
                        questionWrapper.className = 'question-block mb-6';
                        questionWrapper.id = `q-wrapper-${q.displayNum}`;

                        if (q.type === 'input') {
                             questionWrapper.innerHTML = `
                                <p class="mb-3 text-slate-700 leading-relaxed">${createQuestionHTML(q)}</p>
                                <textarea name="q${q.displayNum}" rows="1" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-slate-100 text-slate-900" autocomplete="off"></textarea>
                                ${createNotesHTML(q.displayNum)}
                            `;
                        } else if (q.type === 'paragraph_error_id') {
                            const para = document.createElement('div');
                            para.innerHTML = q.question;
                            questionWrapper.appendChild(para);

                            const inputsContainer = document.createElement('div');
                            inputsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mt-4';
                            q.parts.forEach((part, index) => {
                                const inputId = `q${q.displayNum}_part${index}`;
                                const inputGroup = document.createElement('div');
                                inputGroup.className = 'flex items-center';
                                inputGroup.innerHTML = `
                                    <label for="${inputId}" class="w-32 text-sm text-slate-500 font-mono text-right pr-4">${part.label} &rarr;</label>
                                    <input type="text" id="${inputId}" name="${inputId}" class="flex-grow block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-slate-100 text-slate-900">
                                `;
                                inputsContainer.appendChild(inputGroup);
                            });
                            questionWrapper.appendChild(inputsContainer);
                            questionWrapper.insertAdjacentHTML('beforeend', createNotesHTML(q.displayNum));

                        } else { // MC questions
                             questionWrapper.innerHTML = `
                                <p class="mb-3 text-slate-700 leading-relaxed">${createQuestionHTML(q)}</p>
                                ${createNotesHTML(q.displayNum)}
                            `;
                        }
                        questionsContainer.appendChild(questionWrapper);
                    });
                }
            }
            loadNotes();
            addNotesListeners();
            renderSubmissionArea();

            if (testState[block].completed) {
                enterReviewMode(block, testState[block].answers);
            }
        };
        
        function renderSubmissionArea() {
            submissionArea.innerHTML = '';
            if (testState[currentBlock].completed) {
                const p = document.createElement('p');
                p.className = 'text-green-600 font-semibold';
                p.textContent = `Block ${String.fromCharCode(64 + currentBlock)} Completed.`;
                submissionArea.appendChild(p);
            } else {
                submissionArea.innerHTML = `
                    <hr class="border-slate-200 my-8">
                    <button type="button" id="submit-block-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 shadow-md">
                        Submit Block ${String.fromCharCode(64 + currentBlock)}
                    </button>`;
                document.getElementById('submit-block-btn').addEventListener('click', handleBlockSubmit);
            }
            
            const completedBlocks = Object.values(testState).filter(b => b.completed).length;
            if (completedBlocks > 0) {
                 const buttonContainer = document.createElement('div');
                 buttonContainer.className = 'mt-6 flex flex-col md:flex-row justify-center items-center gap-4';
                 buttonContainer.innerHTML = `
                    <button type="button" id="view-diagnostics-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">View Diagnostics</button>
                    <button type="button" id="download-notes-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Download All Notes</button>
                    <button type="button" id="retake-test-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Retake Full Test</button>
                 `;
                 submissionArea.appendChild(buttonContainer);
                 document.getElementById('view-diagnostics-btn').addEventListener('click', showDiagnostics);
                 document.getElementById('download-notes-btn').addEventListener('click', saveProgress); // Renamed
                 document.getElementById('retake-test-btn').addEventListener('click', () => {
                    if(confirm('Are you sure you want to retake the entire test? All your progress and notes will be lost.')) {
                        localStorage.clear(); // Clears all local storage for the domain, including notes
                        window.location.reload();
                    }
                });
            }
        }
        // --- END: CORE RENDERING ---

        // --- START: EVENT HANDLING & STATE MANAGEMENT ---
        function handleBlockSubmit() {
            const userAnswers = {};
            const blockQuestions = testData.filter(q => q.block === currentBlock);
            
            blockQuestions.forEach(q => {
                if (q.type === 'paragraph_error_id') {
                    q.parts.forEach((part, index) => {
                        const inputEl = document.querySelector(`[name="q${q.displayNum}_part${index}"]`);
                        if(inputEl) userAnswers[`q${q.displayNum}_part${index}`] = inputEl.value.trim().toLowerCase();
                    });
                } else {
                    const inputEl = document.querySelector(`[name="q${q.displayNum}"]`);
                    if(inputEl) userAnswers[`q${q.displayNum}`] = inputEl.value.trim().toLowerCase();
                }
            });

            testState[currentBlock].completed = true;
            testState[currentBlock].answers = userAnswers;
            localStorage.setItem('verbTestState', JSON.stringify(testState));
            
            enterReviewMode(currentBlock, userAnswers);
            renderSubmissionArea();
        }

        const switchTab = (block) => {
            currentBlock = block;
            tabs.forEach(tab => {
                tab.classList.toggle('tab-active', tab.id === `tab-block-${block}`);
                tab.classList.toggle('tab-inactive', tab.id !== `tab-block-${block}`);
            });
            renderQuestions(currentBlock);
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const block = parseInt(tab.id.split('-')[2]);
                switchTab(block);
            });
        });
        // --- END: EVENT HANDLING & STATE MANAGEMENT ---
        
        // --- START: HELPER FUNCTIONS (HTML Generation) ---
        function createQuestionHTML(q) {
            if (q.type === 'mc') {
                return `<span class="font-bold">${q.displayNum}.</span> ${q.question.replace(/______/g, createDropdown(q.displayNum, q.choices))}`;
            } else {
                return `<span class="font-bold">${q.displayNum}.</span> ${q.question}`;
            }
        }

        function createDropdown(displayNum, choices) {
            const options = choices.map((choice, index) => `<option value="${String.fromCharCode(65 + index)}">${choice}</option>`).join('');
            const choiceDisplay = choices.map((choice, index) => 
                `<span class="mc-option-item">(${String.fromCharCode(65 + index)}) ${choice}</span>`
            ).join('');
            return `
                <select name="q${displayNum}" class="inline-select"><option value="">Select...</option>${options}</select>
                <div class="mc-options-display">${choiceDisplay}</div>
            `;
        }

        function createNotesHTML(displayNum) {
            return `
                <div class="mt-2">
                    <button type="button" class="notes-toggle-btn text-xs text-slate-500 hover:text-slate-800">Hide Notes</button>
                    <div class="notes-content mt-1">
                        <textarea id="notes-${displayNum}" placeholder="Notes..." class="w-full h-24 p-2 bg-slate-50 border border-slate-200 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </div>
            `;
        }
        // --- END: HELPER FUNCTIONS (HTML Generation) ---

        // --- START: NOTES HANDLING ---
        function addNotesListeners() {
            document.querySelectorAll('textarea[id^="notes-"]').forEach(area => {
                area.addEventListener('keyup', (e) => {
                    localStorage.setItem(e.target.id, e.target.value);
                });
            });
            document.querySelectorAll('.notes-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const content = e.target.nextElementSibling;
                    content.classList.toggle('hidden');
                    e.target.textContent = content.classList.contains('hidden') ? 'Show Notes' : 'Hide Notes';
                });
            });
        }

        function loadNotes() {
            document.querySelectorAll('textarea[id^="notes-"]').forEach(area => {
                const savedNote = localStorage.getItem(area.id);
                if (savedNote) {
                    area.value = savedNote;
                }
            });
        }
        
        function saveProgress() { // Renamed from downloadNotes
            const allData = {
                testState: testState,
                notes: {}
            };
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('notes-')) {
                    allData.notes[key] = localStorage.getItem(key);
                }
            }
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'verb-diagnostic-progress.json'; // Changed filename
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadProgress() {
            loadFileInput.click(); // Trigger the hidden file input
        }

        loadFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    // Clear current local storage before loading new data
                    localStorage.clear();

                    // Load test state
                    if (loadedData.testState) {
                        testState = loadedData.testState;
                        localStorage.setItem('verbTestState', JSON.stringify(testState));
                    }

                    // Load notes
                    if (loadedData.notes) {
                        for (const key in loadedData.notes) {
                            localStorage.setItem(key, loadedData.notes[key]);
                        }
                    }
                    
                    // Re-render the current block based on loaded state
                    // Find the first incomplete block or default to block 1
                    let blockToRender = 1;
                    for (let i = 1; i <= 3; i++) {
                        if (!testState[i].completed) {
                            blockToRender = i;
                            break;
                        }
                    }
                    switchTab(blockToRender); // This will call renderQuestions and update UI
                    alert('Progress loaded successfully!');

                } catch (error) {
                    alert('Error loading progress: Invalid JSON file or data structure.');
                    console.error('Error loading progress:', error);
                }
            };
            reader.readAsText(file);
        });

        // Add event listeners for the new buttons in intro-view
        document.getElementById('save-progress-btn').addEventListener('click', saveProgress);
        document.getElementById('load-progress-btn').addEventListener('click', loadProgress);

        // --- END: NOTES HANDLING ---

        // --- START: REVIEW & DIAGNOSTICS ---
        function enterReviewMode(block, userAnswers) {
            document.querySelectorAll(`form input, form select, form textarea`).forEach(el => {
                el.disabled = true;
            });

            const blockQuestions = testData.filter(q => q.block === block);
            blockQuestions.forEach(q => {
                const wrapper = document.getElementById(`q-wrapper-${q.displayNum}`);
                if (!wrapper) return;

                if (q.type === 'paragraph_error_id') {
                    q.parts.forEach((part, index) => {
                        const partIdName = `q${q.displayNum}_part${index}`;
                        const userAnswer = userAnswers[partIdName] || '';
                        const isCorrect = userAnswer === part.answer.toLowerCase();
                        const inputEl = document.querySelector(`[name="${partIdName}"]`);
                        if (inputEl) {
                            inputEl.value = userAnswer; // Display user's answer
                            inputEl.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
                            
                            const feedbackContainer = document.createElement('div');
                            feedbackContainer.className = 'feedback-container mt-1 ml-32 pl-4 flex items-center gap-4';
                            
                            const correctAnswerEl = document.createElement('div');
                            correctAnswerEl.className = 'correct-answer-text text-sm text-green-600 font-semibold';
                            correctAnswerEl.textContent = `Correct: ${part.answer}`;
                            feedbackContainer.appendChild(correctAnswerEl);

                            if (!isCorrect) {
                                const markCorrectBtn = document.createElement('button');
                                markCorrectBtn.type = 'button';
                                markCorrectBtn.className = 'mark-correct-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded-lg transition-colors';
                                markCorrectBtn.textContent = 'Mark as Correct';
                                feedbackContainer.appendChild(markCorrectBtn);
                            }
                            inputEl.parentElement.appendChild(feedbackContainer);
                        }
                    });
                     const btn = document.createElement('button');
                     btn.type = 'button';
                     btn.className = 'explain-btn text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-full transition-colors mt-4';
                     btn.textContent = 'Explain';
                     wrapper.appendChild(btn);
                     const explanationContent = document.createElement('div');
                     explanationContent.className = 'explanation-content hidden mt-3 pt-3 border-t border-slate-200 text-sm text-slate-700 prose max-w-none';
                     explanationContent.innerHTML = q.parts.map(p => `<div><p><b>${p.label} &rarr; ${p.answer}:</b> ${p.explanation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p></div>`).join('');
                     wrapper.appendChild(explanationContent);

                } else {
                    const inputEl = document.querySelector(`[name="q${q.displayNum}"]`);
                    if (!inputEl) return;
                    
                    const userAnswer = userAnswers[`q${q.displayNum}`] || '';
                    let isCorrect = false;
                    if (q.type === 'mc') {
                        isCorrect = userAnswer.toUpperCase() === q.answer;
                        inputEl.classList.add('review-select');
                        inputEl.value = userAnswer; // Set selected value for MC

                        // Highlight selected option and correct option in the displayed choices
                        const optionsDisplay = wrapper.querySelector('.mc-options-display');
                        if (optionsDisplay) {
                            optionsDisplay.querySelectorAll('.mc-option-item').forEach(item => {
                                const optionValue = item.textContent.match(/\((.)\)/)[1]; // Extract A, B, C, D
                                if (optionValue === q.answer) {
                                    item.classList.add('correct');
                                }
                                if (optionValue === userAnswer.toUpperCase() && optionValue !== q.answer) {
                                    item.classList.add('incorrect-selected');
                                }
                            });
                        }

                    } else { // For 'input' type (sentence transformation)
                        isCorrect = userAnswer.toLowerCase() === q.answer.toLowerCase(); // Compare lowercase answers
                        inputEl.value = userAnswer; // Display user's answer
                    }
                    
                    inputEl.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
                    
                    // Always show correct answer for input and MC if incorrect
                    if (!isCorrect) {
                        const feedbackContainer = document.createElement('div');
                        feedbackContainer.className = 'feedback-container mt-2 flex items-center gap-4';
                        
                        const correctAnswerEl = document.createElement('div');
                        correctAnswerEl.className = 'correct-answer-text text-sm text-green-600 font-semibold';
                        let correctAnswerText = q.type === 'mc' ? `Correct: (${q.answer}) ${q.choices[q.answer.charCodeAt(0) - 65]}` : `Correct: ${q.answer}`;
                        correctAnswerEl.textContent = correctAnswerText;
                        
                        const markCorrectBtn = document.createElement('button');
                        markCorrectBtn.type = 'button';
                        markCorrectBtn.className = 'mark-correct-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded-lg transition-colors';
                        markCorrectBtn.textContent = 'Mark as Correct';
                        
                        feedbackContainer.appendChild(correctAnswerEl);
                        feedbackContainer.appendChild(markCorrectBtn);
                        inputEl.parentElement.appendChild(feedbackContainer);
                    }
                    
                    // Add explain button for all individual questions
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'explain-btn text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-full transition-colors mt-4';
                    btn.textContent = 'Explain';
                    
                    const explanationContent = document.createElement('div');
                    explanationContent.className = 'explanation-content hidden mt-3 pt-3 border-t border-slate-200 text-sm text-slate-700 prose max-w-none';
                    explanationContent.innerHTML = q.explanation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    wrapper.appendChild(btn);
                    wrapper.appendChild(explanationContent);
                }
            });

            document.querySelectorAll('.explain-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const content = e.target.parentElement.querySelector('.explanation-content');
                    content.classList.toggle('hidden');
                    e.target.textContent = content.classList.contains('hidden') ? 'Explain' : 'Hide';
                });
            });

            document.querySelectorAll('.mark-correct-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.target;
                    const feedbackContainer = button.parentElement;
                    const inputEl = feedbackContainer.parentElement.querySelector('[name^="q"], [id^="q"]');
                    
                    if (inputEl) {
                        inputEl.classList.remove('incorrect-answer');
                        inputEl.classList.add('correct-answer');
                    }
                    
                    feedbackContainer.remove();
                });
            });
        }
        
        function showDiagnostics() {
            testContainer.classList.add('hidden');
            document.getElementById('intro-view').classList.add('hidden');
            diagnosticsView.classList.remove('hidden');
            
            const allCompleted = testState[1].completed && testState[2].completed && testState[3].completed;
            
            document.getElementById('diag-tab-block-a').disabled = !testState[1].completed;
            document.getElementById('diag-tab-block-b').disabled = !testState[2].completed;
            document.getElementById('diag-tab-block-c').disabled = !testState[3].completed;
            document.getElementById('diag-tab-overall').disabled = !allCompleted;

            let firstActiveTab = '';
            if (allCompleted) {
                firstActiveTab = 'overall';
            } else if (testState[1].completed) {
                firstActiveTab = 'block-a';
            } else if (testState[2].completed) {
                firstActiveTab = 'block-b';
            } else if (testState[3].completed) {
                firstActiveTab = 'block-c';
            }
            
            if(firstActiveTab) {
                switchDiagTab(firstActiveTab);
            }

            renderAllCharts();
        }

        function renderAllCharts() {
            const results = [];
            testData.forEach(q => {
                if (!testState[q.block].completed) return;
                const blockAnswers = testState[q.block].answers;
                if (q.type === 'paragraph_error_id') {
                    q.parts.forEach((part, index) => {
                        results.push({ ...part, block: q.block, category: q.category, isCorrect: (blockAnswers[`q${q.displayNum}_part${index}`] || '').toLowerCase() === part.answer.toLowerCase() });
                    });
                } else {
                     const userAnswer = blockAnswers[`q${q.displayNum}`] || '';
                     let isCorrect = false;
                     if (q.type === 'mc') {
                         isCorrect = userAnswer.toUpperCase() === q.answer;
                     } else {
                         isCorrect = userAnswer.toLowerCase() === q.answer.toLowerCase(); // Ensure case-insensitive comparison
                     }
                    results.push({ ...q, isCorrect });
                }
            });

            if (testState[1].completed && testState[2].completed && testState[3].completed) {
                renderDiagnosticChart('overallChart', results);
            }
            if (testState[1].completed) renderDiagnosticChart('blockAChart', results.filter(r => r.block === 1));
            if (testState[2].completed) renderDiagnosticChart('blockBChart', results.filter(r => r.block === 2));
            if (testState[3].completed) renderDiagnosticChart('blockCChart', results.filter(r => r.block === 3));
        }

        function renderDiagnosticChart(canvasId, results) {
            const categories = [...new Set(results.map(r => r.category))];
            
            const categoryData = categories.map(cat => {
                const catQuestions = results.filter(r => r.category === cat);
                const correctCount = catQuestions.filter(r => r.isCorrect).length;
                const totalCount = catQuestions.length;
                const score = totalCount > 0 ? (correctCount / totalCount) * 100 : 0;
                return { category: cat, score, raw: `${correctCount}Q/${totalCount}Q` };
            });

            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryData.map(d => d.category),
                    datasets: [{
                        label: '% Correct',
                        data: categoryData.map(d => d.score),
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#64748b' },
                            grid: { color: 'rgba(226, 232, 240, 0.5)' }
                        },
                        y: {
                            ticks: { color: '#334155' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw.toFixed(1)}%`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#1e293b',
                            font: { weight: 'bold' },
                            formatter: (value, context) => {
                                return categoryData[context.dataIndex].raw;
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('back-to-review-btn').addEventListener('click', () => {
            diagnosticsView.classList.add('hidden');
            testContainer.classList.remove('hidden');
            document.getElementById('intro-view').classList.remove('hidden');
        });

        function switchDiagTab(tabName) {
            const targetId = `diag-content-${tabName}`;
            diagTabs.forEach(t => {
                t.classList.toggle('tab-active', t.dataset.tab === tabName);
                t.classList.toggle('tab-inactive', t.dataset.tab !== tabName);
            });
            document.querySelectorAll('.diag-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== targetId);
            });
        }

        diagTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if(!tab.disabled) {
                    switchDiagTab(tab.dataset.tab);
                }
            });
        });
        // --- END: REVIEW & DIAGNOSTICS ---

        // Initial render
        renderQuestions(currentBlock);
    });
    </script>
</body>
</html>
