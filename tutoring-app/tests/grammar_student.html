<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Grammar Diagnostic for TOEIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-inactive { border-bottom-color: transparent; color: #475569; }
        .question-block { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .inline-select, .review-select {
            display: inline-block;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.1rem 2rem 0.1rem 0.4rem;
            color: #1e293b;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.25rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }
        .review-select:disabled { background-image: none; }
        .correct-answer { border-color: #10b981 !important; background-color: rgba(16, 185, 129, 0.1) !important; }
        .incorrect-answer { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.1) !important; }
        .example {
            border-left: 4px solid #94a3b8;
            padding-left: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            background-color: #f8fafc;
            font-size: 0.95rem;
            color: #334155;
        }
        .mc-options-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-left: 0.25rem;
        }
        .mc-option-item {
            background-color: #e2e8f0;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .mc-option-item.correct {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            font-weight: 600;
        }
        .mc-option-item.incorrect-selected {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Applied Grammar Diagnostic</h1>
            <p class="text-slate-600 mt-2">An interactive assessment for TOEIC Preparation (B2-C1 Level)</p>
        </header>
        
        <div id="intro-view" class="bg-white p-6 rounded-lg shadow-md mb-8 prose max-w-none">
            <h2 class="text-slate-900">Instructions and Test Overview</h2>
            <p>This diagnostic test is designed to identify specific strengths and weaknesses in your understanding of applied English grammar. It is not about getting a simple score, but about pinpointing the exact grammatical rules you need to focus on.</p>
            <p>The test is divided into three blocks. Each block should take approximately 30 minutes. The questions are challenging and often test several grammar points at once.</p>
            <ul>
                <li>Complete and submit each block independently. Your progress is saved automatically.</li>
                <li>Use the provided "Notes" areas for complex questions to jot down your thought process.</li>
            </ul>
            <p class="mt-4">
                You can **Save** your current test progress and notes at any time by clicking "Save Progress (JSON)". This will download a JSON file to your device.
                To **Load** a previously saved test or continue from where you left off, click "Load Progress (JSON)" and select your saved JSON file. This will overwrite any current unsaved progress.
            </p>
            <div class="mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                <button type="button" id="save-progress-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Save Progress (JSON)</button>
                <button type="button" id="load-progress-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Load Progress (JSON)</button>
                <input type="file" id="load-file-input" accept=".json" class="hidden">
            </div>
            <p class="mt-4">After submitting a block, you will enter "Review Mode" to see your results directly on the test. You can then proceed to the "Diagnostics" page for a performance breakdown.</p>
            <p>Good luck. Begin with Block A when you are ready.</p>
        </div>

        <div>
            <div id="test-container" class="bg-white p-6 rounded-lg shadow-md">
                <div id="test-view">
                    <div class="mb-6 border-b border-slate-200">
                        <nav class="flex space-x-6" aria-label="Tabs">
                            <button id="tab-block-1" class="tab-btn py-3 px-1 text-sm font-medium tab-active">Block A</button>
                            <button id="tab-block-2" class="tab-btn py-3 px-1 text-sm font-medium tab-inactive">Block B</button>
                            <button id="tab-block-3" class="tab-btn py-3 px-1 text-sm font-medium tab-inactive">Block C</button>
                        </nav>
                    </div>
                    <form id="diagnostic-form">
                        <div id="questions-container"></div>
                        <div id="submission-area" class="mt-8 text-center"></div>
                    </form>
                </div>
            </div>

            <div id="diagnostics-view" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-900">Performance Diagnostics</h2>
                    <button id="back-to-review-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-md">
                        &larr; Back to Test Review
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="mb-6 border-b border-slate-200">
                        <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                            <button id="diag-tab-overall" data-tab="overall" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Overall</button>
                            <button id="diag-tab-block-a" data-tab="block-a" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Block A</button>
                            <button id="diag-tab-block-b" data-tab="block-b" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Block B</button>
                            <button id="diag-tab-block-c" data-tab="block-c" class="diag-tab-btn mr-6 py-3 px-1 text-sm font-medium tab-inactive" disabled>Block C</button>
                        </nav>
                    </div>
                    <div id="diag-content-overall" class="diag-content hidden">
                        <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="overallChart"></canvas> </div>
                    </div>
                    <div id="diag-content-block-a" class="diag-content hidden">
                         <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="blockAChart"></canvas> </div>
                    </div>
                    <div id="diag-content-block-b" class="diag-content hidden">
                         <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="blockBChart"></canvas> </div>
                    </div>
                    <div id="diag-content-block-c" class="diag-content hidden">
                         <div class="chart-container relative w-full mx-auto h-[28rem]"> <canvas id="blockCChart"></canvas> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START: DATA ---
    Chart.register(ChartDataLabels);

    const testData = [
        // Block A
        {
            block: 1, displayNum: 'A1', section: 'A: Advanced Article and Quantifier Application', sectionExplanation: 'Complete the following text by selecting a suitable word from the word bank for each blank.', type: 'paragraph_input', category: 'Articles & Quantifiers',
            wordBank: {
                correct: ['the', 'a', 'each', 'some', 'much', 'little', 'less'], // '--' is handled by '(leave blank)'
                intruders: ['an', 'any', 'many', 'few', 'more', 'every', 'several', 'all', 'no', 'another']
            },
            question: `<div class="p-4 border-l-4 border-slate-200 bg-slate-50 text-slate-700 leading-relaxed">
                <p class="font-bold">To:</p> <p>All Department Heads</p>
                <p class="font-bold">From:</p> <p>Office of the President</p>
                <p class="font-bold">Subject:</p> <p>Review of Annual Departmental Reports</p>
                <br>
                <p>This memo outlines the procedure for submitting {1} annual reports. Following our review of {2} submissions from last year, it has become clear that {3} new standard for clarity and conciseness is required. {4} department is expected to adhere to the guidelines detailed below.</p>
                <p>We value {5} creativity and innovation; however, the primary goal is {6} effective communication of results. {7} report should be no more than ten pages and must include a summary of {8} major achievements. Please note that while {9} information is useful, too {10} detail can obscure the main points. We have {11} patience for reports that are excessively long. Therefore, spend {12} time on formatting and more on content.</p>
            </div>`,
            parts: [
                { answer: 'the', explanation: "Definite article for a specific, known procedure." },
                { answer: 'the', explanation: "Refers to specific submissions from a known year." },
                { answer: 'a', explanation: "Indefinite article for a new, singular standard." },
                { answer: 'each', explanation: "Quantifier for individual members of a group ('every' is also a valid option but 'each' fits better)." },
                { answer: '--', explanation: "Zero article for abstract nouns ('creativity') used in a general sense." },
                { answer: 'the', explanation: "Specific goal that has been defined." },
                { answer: 'each', explanation: "Quantifier for individual reports ('every' also correct)." },
                { answer: '--', explanation: "Zero article for plural noun ('achievements') in a general sense." },
                { answer: 'some', explanation: "Quantifier for uncountable 'information' ('much' also correct)." },
                { answer: 'much', explanation: "Quantifier for uncountable 'detail'." },
                { answer: 'little', explanation: "Quantifier with negative meaning for uncountable 'patience'." },
                { answer: 'less', explanation: "Comparative quantifier for uncountable 'time'." }
            ]
        },
        { block: 1, displayNum: 'A2', section: 'B: Multi-Error Identification', sectionExplanation: 'The following sentences each contain multiple grammatical errors. Identify the errors and write the fully corrected sentence in the box.', type: 'input_correction', category: 'Pronouns & Articles', question: `The new intern, which has a degree in the marketing, seems to have a little knowledge of our company's history, but he shows many enthusiasm for learning.`, answer: "the new intern, who has a degree in marketing, seems to have little knowledge of our company's history, but he shows a lot of/great enthusiasm for learning.", explanation: "**Relative Pronoun:** `which` -> `who` (for people).<br>**Zero Article:** `the marketing` -> `marketing` (field of study).<br>**Quantifier Nuance:** `a little` -> `little` ('but' implies contrast, so negative meaning needed).<br>**Quantifier (Uncountable):** `many` -> `a lot of/great` ('enthusiasm' is uncountable)." },
        { block: 1, displayNum: 'A3', section: 'B: Multi-Error Identification', type: 'input_correction', category: 'Agreement & Parallelism', question: `Each of the proposals were evaluated based on its feasibility, their cost-effectiveness, and they were also checked for originality.`, answer: "each of the proposals was evaluated based on its feasibility, its cost-effectiveness, and its originality.", explanation: "**Subject-Verb Agreement:** `Each ... were` -> `Each ... was` ('Each' is singular).<br>**Pronoun Agreement:** `their` -> `its` (antecedent 'Each' is singular).<br>**Parallelism:** `they were also checked` -> `its originality` (maintains the list of nouns)." },
        { block: 1, displayNum: 'A4', section: 'B: Multi-Error Identification', type: 'input_correction', category: 'Word Form & Prepositions', question: `For be successful in this industry, one needs not only an understanding of the technology but also to have the ability to work good with others under a pressure.`, answer: "to be successful in this industry, one needs not only an understanding of the technology but also the ability to work well with others under pressure.", explanation: "**Infinitive of Purpose:** `For be` -> `To be`.<br>**Adverb Form:** `work good` -> `work well`.<br>**Zero Article:** `under a pressure` -> `under pressure` (idiomatic expression)." },
        { block: 1, displayNum: 'A5', section: 'B: Multi-Error Identification', type: 'input_correction', category: 'Clauses & Word Form', question: `The data, that was collected from over thousand individuals, suggest that there has been a raise in public interest for environmental issues.`, answer: "the data, which was collected from over a thousand individuals, suggest that there has been a rise in public interest in environmental issues.", explanation: "**Relative Clause:** `that` -> `which` (non-defining clause).<br>**Article:** `over thousand` -> `over a thousand`.<br>**Word Form:** `a raise` -> `a rise` (noun form).<br>**Preposition:** `interest for` -> `interest in`." },
        { block: 1, displayNum: 'A6', section: 'B: Multi-Error Identification', type: 'input_correction', category: 'Nouns & Agreement', question: `A number of equipment in the lab needs to be upgraded, as it is no longer adequate for performing so complex experiments.`, answer: "a number of pieces of equipment in the lab need to be upgraded, as they are no longer adequate for performing such complex experiments.", explanation: "**Countable/Uncountable:** `equipment` -> `pieces of equipment`.<br>**Subject-Verb Agreement:** `A number of ... need` (plural verb).<br>**Pronoun Agreement:** `it is` -> `they are` (referring to 'pieces').<br>**Determiner:** `so complex` -> `such complex`." },
        { block: 1, displayNum: 'A7', section: 'C: Sentence Transformation', sectionExplanation: 'Rewrite each sentence according to the instruction. This tests complex structures. For example:<ul><li class="my-1"><b>Participle Clause:</b> "He was walking down the street. He saw an accident." &rarr; "<b>Walking</b> down the street, he saw an accident."</li><li class="my-1"><b>Inversion:</b> "I have never seen such a thing." &rarr; "<b>Never have I seen</b> such a thing."</li><li class="my-1"><b>Cleft Sentence:</b> "John broke the window." &rarr; "<b>It was John who</b> broke the window."</li></ul>', type: 'input_rewrite', category: 'Sentence Structure', question: `The company invested heavily in research and development. It aimed to outperform its competitors. <br><em>(Rewrite as one sentence using a present participle clause.)</em>`, answer: "aiming to outperform its competitors, the company invested heavily in research and development.", explanation: "Uses a present participle clause to show purpose/reason." },
        { block: 1, displayNum: 'A8', section: 'C: Sentence Transformation', type: 'input_rewrite', category: 'Sentence Structure', question: `You will seldom witness such a remarkable display of teamwork. <br><em>(Rewrite to add emphasis, starting with the word 'Seldom'.)</em>`, answer: "seldom will you witness such a remarkable display of teamwork.", explanation: "Uses inversion after a negative adverbial for emphasis." },
        { block: 1, displayNum: 'A9', section: 'C: Sentence Transformation', type: 'input_rewrite', category: 'Sentence Structure', question: `The project was not only completed behind schedule, but also it went over budget. <br><em>(Rewrite to improve the parallelism of the structure.)</em>`, answer: "the project was not only completed behind schedule but also went over budget.", explanation: "Corrects parallelism by removing the redundant pronoun 'it'." },
        { block: 1, displayNum: 'A10', section: 'C: Sentence Transformation', type: 'input_rewrite', category: 'Sentence Structure', question: `If the government had not intervened, the financial crisis would have been much worse. <br><em>(Rewrite using inversion, removing the word 'if'.)</em>`, answer: "had the government not intervened, the financial crisis would have been much worse.", explanation: "Forms a third conditional using inversion ('Had' + subject + past participle)." },
        { block: 1, displayNum: 'A11', section: 'C: Sentence Transformation', type: 'input_rewrite', category: 'Sentence Structure', question: `The CEO made the final decision. <br><em>(Rewrite as a cleft sentence to emphasize 'The CEO'.)`, answer: "it was the ceo who made the final decision.", explanation: "Uses a cleft sentence ('It was...') to emphasize the subject." },

        // Block B
        { block: 2, displayNum: 'B1', section: 'A: Complex Clause Construction', sectionExplanation: 'Read the text below and choose the best word or phrase (A, B, C, or D) for each space.', type: 'mc', category: 'Relative Clauses', question: `The city council has approved a controversial plan to redevelop the waterfront, a decision ______ has angered many local residents.`, choices: ['that', 'which', 'what', 'it'], answer: 'B', explanation: "A non-defining relative clause (set off by a comma) referring to a thing ('decision') requires 'which'." },
        { block: 2, displayNum: 'B2', section: 'A: Complex Clause Construction', type: 'mc', category: 'Relative Clauses', question: `The project, ______ involves constructing a new luxury hotel..., is intended to boost tourism.`, choices: ['that', 'whose', 'which', 'who'], answer: 'C', explanation: "A non-defining relative clause referring to a thing ('project') requires 'which'." },
        { block: 2, displayNum: 'B3', section: 'A: Complex Clause Construction', type: 'mc', category: 'Relative Clauses', question: `...the area's unique character, ______ is a major draw for visitors in the first place.`, choices: ['that', 'which', 'what', 'where'], answer: 'B', explanation: "A non-defining relative clause referring to a thing ('character') requires 'which'." },
        { block: 2, displayNum: 'B4', section: 'A: Complex Clause Construction', type: 'mc', category: 'Relative Clauses', question: `Councilwoman Jenkins, ______ constituents are among the most vocal critics, defended the decision.`, choices: ['who', 'which', 'that', 'whose'], answer: 'D', explanation: "The possessive relative pronoun 'whose' is needed to connect 'constituents' to 'Jenkins'." },
        { block: 2, displayNum: 'B5', section: 'A: Complex Clause Construction', type: 'mc', category: 'Conjunctions', question: `She stated that the council would proceed ______ a formal environmental impact report is submitted and approved.`, choices: ['if', 'whereas', 'unless', 'despite'], answer: 'C', explanation: "'Unless' introduces a negative condition (i.e., the council will NOT proceed if a report is NOT submitted)." },
        { block: 2, displayNum: 'B6', section: 'A: Complex Clause Construction', type: 'mc', category: 'Relative Clauses', question: `...there would be a public hearing ______ residents can voice their concerns.`, choices: ['which', 'that', 'where', 'when'], answer: 'C', explanation: "The relative adverb 'where' is used to refer to a place (the hearing)." },
        { block: 2, displayNum: 'B7', section: 'A: Complex Clause Construction', type: 'mc', category: 'Noun Clauses', question: `It remains to be seen ______ these assurances will satisfy the community...`, choices: ['if', 'whether', 'that', 'what'], answer: 'B', explanation: "'Whether' is used to introduce a noun clause that involves uncertainty or two possibilities. 'If' is less formal and sometimes avoided in this position." },
        { block: 2, displayNum: 'B8', section: 'A: Complex Clause Construction', type: 'mc', category: 'Relative Clauses', question: `...the community, ______ has already organized a protest for next Saturday.`, choices: ['that', 'whom', 'which', 'who'], answer: 'D', explanation: "Although 'community' can be a thing, here it refers to the people within it, so 'who' is the most appropriate choice. 'Which' is also sometimes used but 'who' is preferred." },
        { block: 2, displayNum: 'B9', section: 'B: Advanced Reported Speech', sectionExplanation: 'Change the following from direct to reported speech. Remember to backshift tenses (e.g., present simple &rarr; past simple) and change pronouns and time/place words where necessary. For example:<ul><li class="my-1"><b>Statement:</b> "I am tired," she said. &rarr; She said she <b>was</b> tired.</li><li class="my-1"><b>Question:</b> "Where are you going?" he asked. &rarr; He asked where I <b>was going</b>.</li><li class="my-1"><b>Command:</b> "Sit down," he told me. &rarr; He told me <b>to sit</b> down.</li></ul>', type: 'input_rewrite', category: 'Reported Speech', question: `The manager said to the team, "We must complete this project by the end of the month, no matter what."`, answer: "the manager insisted that the team (must/should) complete the/that project by the end of the/that month.", explanation: "Uses a reporting verb 'insisted' followed by a 'that'-clause. 'Must' can remain or change to 'had to'." },
        { block: 2, displayNum: 'B10', section: 'B: Advanced Reported Speech', type: 'input_rewrite', category: 'Reported Speech', question: `"Why haven't you submitted your weekly report yet?" my supervisor asked me.`, answer: "my supervisor asked me why i hadn't submitted my weekly report yet.", explanation: "Changes a direct question to a reported question, requiring a word order change and tense backshift (present perfect -> past perfect)." },
        { block: 2, displayNum: 'B11', section: 'B: Advanced Reported Speech', type: 'input_rewrite', category: 'Reported Speech', question: `"Let's reschedule the meeting for next Tuesday," said my colleague.`, answer: "my colleague suggested rescheduling the meeting for the following tuesday.", explanation: "Reports a suggestion using 'suggested' followed by a gerund. Time reference changes." },
        { block: 2, displayNum: 'B12', section: 'B: Advanced Reported Speech', type: 'input_rewrite', category: 'Reported Speech', question: `The safety inspector told the workers, "Don't operate this machinery without wearing your safety goggles."`, answer: "the safety inspector warned/told the workers not to operate that machinery without wearing their safety goggles.", explanation: "Reports a command/warning using 'warned/told' + object + 'not to' + infinitive." },
        { block: 2, displayNum: 'B13', section: 'B: Advanced Reported Speech', type: 'input_rewrite', category: 'Reported Speech', question: `"I may not be able to attend the conference tomorrow," she informed us.`, answer: "she informed us that she might not be able to attend the conference the next/following day.", explanation: "Reports a statement with a modal verb, requiring backshift ('may' -> 'might') and a change in time reference." },
        { block: 2, displayNum: 'B14', section: 'C: Grammatical Form and Function', sectionExplanation: 'Choose the best word (A, B, C, or D) to fill the space. The options are different forms of the same root word.', type: 'mc', category: 'Word Formation', question: `The company's ______ on renewable energy sources has significantly reduced its carbon footprint.`, choices: ['dependent', 'dependence', 'depend', 'dependably'], answer: 'B', explanation: "The noun form 'dependence' is required after the possessive 'company's'." },
        { block: 2, displayNum: 'B15', section: 'C: Grammatical Form and Function', type: 'mc', category: 'Word Formation', question: `All new employees must undergo a ______ training program...`, choices: ['compulsion', 'compulsory', 'compulsorily', 'compel'], answer: 'B', explanation: "The adjective form 'compulsory' is needed to modify the noun phrase 'training program'." },
        { block: 2, displayNum: 'B16', section: 'C: Grammatical Form and Function', type: 'mc', category: 'Word Formation', question: `The marketing team's ______ campaign resulted in a 30% increase in sales.`, choices: ['imagine', 'imaginative', 'imagination', 'imaginatively'], answer: 'B', explanation: "The adjective form 'imaginative' is needed to modify the noun 'campaign'." },
        { block: 2, displayNum: 'B17', section: 'C: Grammatical Form and Function', type: 'mc', category: 'Word Formation', question: `...the judges' decisions are made completely ______ of the audience's reaction.`, choices: ['independent', 'independence', 'independently', 'depended'], answer: 'C', explanation: "The adverb form 'independently' is needed to modify the verb 'are made'." },
        { block: 2, displayNum: 'B18', section: 'C: Grammatical Form and Function', type: 'mc', category: 'Word Formation', question: `The ______ of the new software system required several months of planning...`, choices: ['implement', 'implementing', 'implemented', 'implementation'], answer: 'D', explanation: "The noun form 'implementation' is required as the subject of the sentence." },
        
        // Block C
        { block: 3, displayNum: 'C1', section: 'A: Integrated Grammar Application', sectionExplanation: 'Read the text below and choose the best word or phrase (A, B, C, or D) for each space.', type: 'mc', category: 'Pronouns', question: `...improve the lives of ______ citizens...`, choices: ['their', 'its', 'it\'s', 'they\'re'], answer: 'B', explanation: "'urban areas' is plural, but the possessive pronoun refers back to the singular concept 'a true smart city'. 'Its' is the correct possessive pronoun." },
        { block: 3, displayNum: 'C2', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Conjunctions', question: `______ simply installing sensors, a true smart city integrates information...`, choices: ['Instead of', 'Rather than', 'In spite of', 'Due to'], answer: 'B', explanation: "'Rather than' is used to contrast two actions or ideas (integrating vs. simply installing)." },
        { block: 3, displayNum: 'C3', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Articles & Quantifiers', question: `...to respond in real-time to ______ flow of vehicles...`, choices: ['a', 'an', 'the', ' -- '], answer: 'C', explanation: "The definite article 'the' is used because it refers to the specific, defined flow of vehicles at that moment." },
        { block: 3, displayNum: 'C4', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Conjunctions', question: `...reducing congestion and, ______, pollution.`, choices: ['as a result', 'however', 'for example', 'in contrast'], answer: 'A', explanation: "'As a result' is a discourse marker that shows a consequence or outcome." },
        { block: 3, displayNum: 'C5', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Pronouns', question: `...is not without ______ challenges.`, choices: ['its', 'it\'s', 'their', 'theirs'], answer: 'A', explanation: "The possessive pronoun 'its' refers back to the singular 'transition'." },
        { block: 3, displayNum: 'C6', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Conjunctions', question: `______ a vast amount of data is collected, ensuring its security becomes paramount.`, choices: ['As long as', 'Provided that', 'Although', 'As'], answer: 'D', explanation: "'As' is used here to mean 'because' or 'since', explaining the reason why security is paramount." },
        { block: 3, displayNum: 'C7', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Conjunctions', question: `______, there is the question of digital inclusion.`, choices: ['In addition', 'On the other hand', 'Nevertheless', 'For instance'], answer: 'A', explanation: "'In addition' is a discourse marker used to add another point or argument." },
        { block: 3, displayNum: 'C8', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Conjunctions', question: `...all residents, ______ of their age or technological proficiency, can benefit...`, choices: ['regardless', 'despite', 'without', 'unless'], answer: 'A', explanation: "'Regardless of' is a prepositional phrase meaning 'without being affected by'." },
        { block: 3, displayNum: 'C9', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Conjunctions', question: `______, the risk is creating a two-tiered society.`, choices: ['Consequently', 'Otherwise', 'Furthermore', 'Instead'], answer: 'B', explanation: "'Otherwise' is used to show the negative consequence if the preceding condition (ensuring inclusion) is not met." },
        { block: 3, displayNum: 'C10', section: 'A: Integrated Grammar Application', type: 'mc', category: 'Comparisons', question: `...depends as ______ on thoughtful policy as it does on technological innovation.`, choices: ['much', 'many', 'more', 'most'], answer: 'A', explanation: "The structure 'as much... as' is used for comparing uncountable nouns ('dependence')." },
        { block: 3, displayNum: 'C11', section: 'B: Multi-Error Identification II', type: 'input_correction', category: 'Mixed Grammar', question: `The committee, that was established to review employee wellness programs, presented their findings at the meeting last week. Its report, a very comprehensive document, recommended several changes, one of which was to rise the subsidy for gym memberships. This particular suggestion was met with immediate approval. However, the chairwoman noted that the board had little viable alternatives, as the current program was more costlier than anticipated. She urged for a quickly decision from management, so that the new initiatives could be implemented before the end of the fiscal year.`, answer: "the committee, which was established to review employee wellness programs, presented its findings at the meeting last week. its report, a very comprehensive document, recommended several changes, one of which was to raise the subsidy for gym memberships. this particular suggestion was met with immediate approval. however, the chairwoman noted that the board had few viable alternatives, as the current program was costlier than anticipated. she urged a quick decision from management, so that the new initiatives could be implemented before the end of the fiscal year.", explanation: "**Relative Clause:** `that` -> `which` (non-defining).<br>**Pronoun Agreement:** `their` -> `its` ('committee' is singular).<br>**Confused Verbs:** `rise` -> `raise` (transitive).<br>**Quantifier:** `little` -> `few` ('alternatives' is countable).<br>**Double Comparative:** `more costlier` -> `costlier`.<br>**Preposition:** `urged for` -> `urged` (transitive).<br>**Adjective Form:** `quickly decision` -> `quick decision`." },
        { block: 3, displayNum: 'C12', section: 'C: Sentence Transformation: Advanced Structures', sectionExplanation: 'Rewrite each sentence according to the instruction, focusing on advanced structures for emphasis and style. For example:<ul><li class="my-1"><b>Inversion with `Not until`</b>: "He didn\'t understand until the end." &rarr; "<b>Not until the end did he understand</b>."</li><li class="my-1"><b>Cleft Sentence with `It is...that`</b>: "The policy caused the change." &rarr; "<b>It is the policy that</b> caused the change."</li></ul>', type: 'input_rewrite', category: 'Sentence Structure', question: `The flight was delayed for three hours because of a severe thunderstorm.<br><em>(Rewrite the sentence starting with 'Due to...'.)</em>`, answer: "due to a severe thunderstorm, the flight was delayed for three hours.", explanation: "Rephrases using 'Due to' to show cause." },
        { block: 3, displayNum: 'C13', section: 'C: Sentence Transformation: Advanced Structures', type: 'input_rewrite', category: 'Sentence Structure', question: `He didn't realize how important the contract was until he had lost the client.<br><em>(Rewrite using 'Not until...' at the beginning of the sentence.)</em>`, answer: "not until he had lost the client did he realize how important the contract was.", explanation: "Uses inversion after 'Not until' for emphasis." },
        { block: 3, displayNum: 'C14', section: 'C: Sentence Transformation: Advanced Structures', type: 'input_rewrite', category: 'Sentence Structure', question: `The government's new environmental policy is the main reason for the recent drop in pollution.<br><em>(Rewrite as a cleft sentence to emphasize 'The government's new environmental policy'.)</em>`, answer: "it is the government's new environmental policy that is the main reason for the recent drop in pollution.", explanation: "Uses a cleft sentence ('It is...') to emphasize the cause." },
        { block: 3, displayNum: 'C15', section: 'C: Sentence Transformation: Advanced Structures', type: 'input_rewrite', category: 'Sentence Structure', question: `The engineers designed the bridge. They ensured it could withstand powerful earthquakes.<br><em>(Rewrite as one sentence using a past participle clause.)</em>`, answer: "designed to withstand powerful earthquakes, the bridge was an engineering marvel.", explanation: "Uses a past participle clause to add descriptive information." },
        { block: 3, displayNum: 'C16', section: 'C: Sentence Transformation: Advanced Structures', type: 'input_rewrite', category: 'Sentence Structure', question: `I have never seen such an impressive performance before.<br><em>(Rewrite the sentence starting with 'Never before...'.)`, answer: "never before have i seen such an impressive performance.", explanation: "Uses inversion after the negative adverbial 'Never before' for emphasis." }
    ];
    // --- END: DATA ---

    // --- START: STATE & DOM ELEMENTS ---
    let currentBlock = 1;
    let chartInstances = {};
    let testState = JSON.parse(localStorage.getItem('grammarTestState')) || {
        1: { completed: false, answers: {} },
        2: { completed: false, answers: {} },
        3: { completed: false, answers: {} }
    };
    
    const testContainer = document.getElementById('test-container');
    const diagnosticsView = document.getElementById('diagnostics-view');
    const questionsContainer = document.getElementById('questions-container');
    const submissionArea = document.getElementById('submission-area');
    const form = document.getElementById('diagnostic-form');
    const tabs = document.querySelectorAll('.tab-btn');
    const diagTabs = document.querySelectorAll('.diag-tab-btn');
    const loadFileInput = document.getElementById('load-file-input'); // Get the hidden file input
    // --- END: STATE & DOM ELEMENTS ---

    // --- START: CORE RENDERING ---
    const renderQuestions = (block) => {
        questionsContainer.innerHTML = '';
        
        const blockQuestions = testData.filter(q => q.block === block);
        
        const sections = new Map();
        blockQuestions.forEach(q => {
            if (!sections.has(q.section)) sections.set(q.section, { questions: [], explanation: q.sectionExplanation });
            sections.get(q.section).questions.push(q);
        });

        for (const [sectionName, data] of sections.entries()) {
            const sectionHeader = document.createElement('h3');
            sectionHeader.className = 'text-lg font-bold text-slate-900 mt-6 mb-4 border-b border-slate-200 pb-2';
            sectionHeader.textContent = sectionName;
            questionsContainer.appendChild(sectionHeader);
            
            if (data.explanation) {
                const explanationP = document.createElement('div');
                explanationP.className = 'text-sm text-slate-600 mb-4 prose prose-sm max-w-none';
                explanationP.innerHTML = data.explanation;
                questionsContainer.appendChild(explanationP);
            }

            const questionWithBank = data.questions.find(q => q.wordBank);
            if (questionWithBank) {
                const bank = [...questionWithBank.wordBank.correct, ...questionWithBank.wordBank.intruders, '(leave blank)'];
                for (let i = bank.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [bank[i], bank[j]] = [bank[j], bank[i]];
                }
                
                const wordBankEl = document.createElement('div');
                wordBankEl.className = 'p-4 border-2 border-dashed border-slate-300 rounded-lg mb-4';
                wordBankEl.innerHTML = `
                    <h4 class="font-bold text-sm text-slate-600 mb-2">Word Bank (for Section A only)</h4>
                    <div class="flex flex-wrap gap-2">
                        ${bank.map(word => `<span class="bg-slate-200 text-slate-700 text-sm font-mono py-1 px-2 rounded-md">${word}</span>`).join('')}
                    </div>
                `;
                questionsContainer.appendChild(wordBankEl);
            }
            
            if (data.questions[0].type === 'input_correction') {
                 const example = document.createElement('div');
                 example.className = 'example p-3 rounded-md';
                 example.innerHTML = `<p><strong>Example:</strong></p>
                    <p><em>Original:</em> Despite of his many efforts and working hardly, the manager found that little of his staffs understood their new responsibilities, which was a great disappointment for he and his team.</p>
                    <p><em>Corrected:</em> <strong>Despite</strong> his many efforts and working <strong>hard</strong>, the manager found that <strong>few</strong> of his <strong>staff</strong> understood their new responsibilities, which was a great disappointment for <strong>him</strong> and his team.</p>`;
                questionsContainer.appendChild(example);
            }

            data.questions.forEach(q => {
                const questionWrapper = document.createElement('div');
                questionWrapper.className = 'question-block mb-6';
                questionWrapper.id = `q-wrapper-${q.displayNum}`;

                if (q.type === 'input_correction' || q.type === 'input_rewrite') {
                    // Determine rows based on block and type
                    const rows = (q.block === 3 && q.section.includes('B: Multi-Error Identification II')) ? 5 : 1;
                    questionWrapper.innerHTML = `
                        <p class="mb-3 text-slate-700 leading-relaxed">${createQuestionHTML(q)}</p>
                        <textarea name="q${q.displayNum}" rows="${rows}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-slate-100 text-slate-900" autocomplete="off"></textarea>
                        ${createNotesHTML(q.displayNum)} <!-- Pass displayNum for notes -->
                    `;
                } else if (q.type === 'paragraph_input') {
                     let questionHTML = q.question;
                     q.parts.forEach((part, index) => {
                         const partIdName = `q${q.displayNum}_part${index}`; // This is for the input's name attribute
                         const noteIdForPart = `${q.displayNum}_part${index}`; // This is for the note's ID, matching JSON
                         // Notes are now per-input for paragraph_input type
                         const inputHTML = `<span class="inline-block" id="input-wrapper-${partIdName}"><input type="text" name="${partIdName}" class="inline-block w-24 mx-1 text-center rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-slate-100 text-slate-900"></span>${createNotesHTML(noteIdForPart)}`; 
                         questionHTML = questionHTML.replace(`{${index + 1}}`, inputHTML);
                     });
                     questionWrapper.innerHTML = `${questionHTML}`;
                } else { // MC questions
                     questionWrapper.innerHTML = `
                        <p class="mb-3 text-slate-700 leading-relaxed">${createQuestionHTML(q)}</p>
                        ${createNotesHTML(q.displayNum)} <!-- Pass displayNum for notes -->
                     `;
                }
                
                questionsContainer.appendChild(questionWrapper);
            });
        }
        loadNotes();
        addNotesListeners();
        renderSubmissionArea();

        if (testState[block].completed) {
            enterReviewMode(block, testState[block].answers);
        }
    };
    
    function renderSubmissionArea() {
        submissionArea.innerHTML = '';
        if (testState[currentBlock].completed) {
            const p = document.createElement('p');
            p.className = 'text-green-600 font-semibold';
            p.textContent = `Block ${String.fromCharCode(64 + currentBlock)} Completed.`;
            submissionArea.appendChild(p);
        } else {
            submissionArea.innerHTML = `
                <hr class="border-slate-200 my-8">
                <button type="button" id="submit-block-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 shadow-md">
                    Submit Block ${String.fromCharCode(64 + currentBlock)}
                </button>`;
            document.getElementById('submit-block-btn').addEventListener('click', handleBlockSubmit);
        }
        
        const completedBlocks = Object.values(testState).filter(b => b.completed).length;
        if (completedBlocks > 0) {
             const buttonContainer = document.createElement('div');
             buttonContainer.className = 'mt-6 flex flex-col md:flex-row justify-center items-center gap-4';
             buttonContainer.innerHTML = `
                <button type="button" id="view-diagnostics-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">View Diagnostics</button>
                <button type="button" id="download-notes-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Download All Notes</button>
                <button type="button" id="retake-test-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md">Retake Full Test</button>
             `;
             submissionArea.appendChild(buttonContainer);
             document.getElementById('view-diagnostics-btn').addEventListener('click', showDiagnostics);
             document.getElementById('download-notes-btn').addEventListener('click', saveProgress); // Renamed
             document.getElementById('retake-test-btn').addEventListener('click', () => {
                // Using a custom modal for confirmation instead of alert/confirm
                showCustomConfirm('Are you sure you want to retake the entire test? All your progress and notes will be lost.', () => {
                    localStorage.clear(); // Clears all local storage for the domain, including notes
                    window.location.reload();
                });
            });
        }
    }
    // --- END: CORE RENDERING ---

    // --- START: EVENT HANDLING & STATE MANAGEMENT ---
    function handleBlockSubmit() {
        const userAnswers = {};
        const blockQuestions = testData.filter(q => q.block === currentBlock);
        
        blockQuestions.forEach(q => {
            if (q.type === 'paragraph_input') {
                q.parts.forEach((part, index) => {
                    const inputEl = document.querySelector(`[name="q${q.displayNum}_part${index}"]`);
                    if(inputEl) userAnswers[`q${q.displayNum}_part${index}`] = inputEl.value.trim();
                });
            } else {
                const inputEl = document.querySelector(`[name="q${q.displayNum}"]`);
                if(inputEl) userAnswers[`q${q.displayNum}`] = inputEl.value.trim().replace(/[.,]/g, '');
            }
        });

        testState[currentBlock].completed = true;
        testState[currentBlock].answers = userAnswers;
        localStorage.setItem('grammarTestState', JSON.stringify(testState));
        
        enterReviewMode(currentBlock, userAnswers);
        renderSubmissionArea();
    }

    const switchTab = (block) => {
        currentBlock = block;
        tabs.forEach(tab => {
            tab.classList.toggle('tab-active', tab.id === `tab-block-${block}`);
            tab.classList.toggle('tab-inactive', tab.id !== `tab-block-${block}`);
        });
        renderQuestions(currentBlock);
    };

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const block = parseInt(tab.id.split('-')[2]);
            switchTab(block);
        });
    });
    // --- END: EVENT HANDLING & STATE MANAGEMENT ---

    // --- START: HELPER FUNCTIONS (HTML Generation) ---
    function createQuestionHTML(q) {
        let questionText = `<span class="font-bold">${q.displayNum}.</span> ${q.question}`;
        if (q.type === 'mc') {
            return questionText.replace(/______/g, createDropdown(q.displayNum, q.choices));
        }
        return questionText;
    }

    function createDropdown(displayNum, choices) {
        const options = choices.map((choice, index) => `<option value="${String.fromCharCode(65 + index)}">${choice}</option>`).join('');
        const choiceDisplay = choices.map((choice, index) => 
            `<span class="mc-option-item">(${String.fromCharCode(65 + index)}) ${choice}</span>`
        ).join('');
        return `
            <select name="q${displayNum}" class="inline-select"><option value="">Select...</option>${options}</select>
            <div class="mc-options-display">${choiceDisplay}</div>
        `;
    }

    function createNotesHTML(elementId) { // Renamed parameter to elementId for clarity
        return `
            <div class="mt-2">
                <button type="button" class="notes-toggle-btn text-xs text-slate-500 hover:text-slate-800">Hide Notes</button>
                <div class="notes-content mt-1">
                    <textarea id="notes-${elementId}" placeholder="Notes..." class="w-full h-24 p-2 bg-slate-50 border border-slate-200 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
            </div>
        `;
    }
    // --- END: HELPER FUNCTIONS (HTML Generation) ---

    // --- START: NOTES HANDLING ---
    function addNotesListeners() {
        document.querySelectorAll('textarea[id^="notes-"]').forEach(area => {
            area.addEventListener('keyup', (e) => {
                localStorage.setItem(e.target.id, e.target.value);
            });
        });
        document.querySelectorAll('.notes-toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const content = e.target.nextElementSibling;
                content.classList.toggle('hidden');
                e.target.textContent = content.classList.contains('hidden') ? 'Show Notes' : 'Hide Notes';
            });
        });
    }

    function loadNotes() {
        // Only load notes for currently rendered elements.
        document.querySelectorAll('textarea[id^="notes-"]').forEach(area => {
            const savedNote = localStorage.getItem(area.id);
            if (savedNote) {
                area.value = savedNote;
                // Ensure the notes container is visible if there's content
                const notesContentDiv = area.closest('.notes-content');
                const notesToggleButton = notesContentDiv ? notesContentDiv.previousElementSibling : null;
                if (notesContentDiv && notesContentDiv.classList.contains('hidden')) {
                    notesContentDiv.classList.remove('hidden');
                    if (notesToggleButton) {
                        notesToggleButton.textContent = 'Hide Notes';
                    }
                }
            }
        });
    }
    
    function saveProgress() { // Renamed from downloadNotes
        const allData = {
            testState: testState,
            notes: {}
        };
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('notes-')) {
                allData.notes[key] = localStorage.getItem(key);
            }
        }
        
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'grammar-diagnostic-progress.json'; // Changed filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function loadProgress() {
        loadFileInput.click(); // Trigger the hidden file input
    }

    loadFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loadedData = JSON.parse(e.target.result);
                
                // Clear current local storage before loading new data
                // This ensures a clean slate for the loaded data.
                localStorage.clear(); 

                // Load test state
                if (loadedData.testState) {
                    testState = loadedData.testState;
                    localStorage.setItem('grammarTestState', JSON.stringify(testState));
                }

                // Load notes
                if (loadedData.notes) {
                    for (const key in loadedData.notes) {
                        localStorage.setItem(key, loadedData.notes[key]);
                    }
                }
                
                // Re-render the current block based on loaded state
                // Find the first incomplete block or default to block 1
                let blockToRender = 1;
                for (let i = 1; i <= 3; i++) {
                    if (!testState[i].completed) {
                        blockToRender = i;
                        break;
                    }
                }
                switchTab(blockToRender); // This will call renderQuestions and update UI
                showCustomAlert('Progress loaded successfully!');

            } catch (error) {
                showCustomAlert('Error loading progress: Invalid JSON file or data structure.');
                console.error('Error loading progress:', error);
            }
        };
        reader.readAsText(file);
    });

    // Add event listeners for the new buttons in intro-view
    document.getElementById('save-progress-btn').addEventListener('click', saveProgress);
    document.getElementById('load-progress-btn').addEventListener('click', loadProgress);

    // --- END: NOTES HANDLING ---

    // --- START: REVIEW & DIAGNOSTICS ---
    function enterReviewMode(block, userAnswers) {
        document.querySelectorAll(`form input, form select, form textarea`).forEach(el => {
            el.disabled = true;
        });

        const blockQuestions = testData.filter(q => q.block === block);
        blockQuestions.forEach(q => {
            const wrapper = document.getElementById(`q-wrapper-${q.displayNum}`);
            if (!wrapper) return;

            if (q.type === 'paragraph_input') {
                q.parts.forEach((part, index) => {
                    const partIdName = `q${q.displayNum}_part${index}`;
                    const userAnswer = (userAnswers[partIdName] || '').toLowerCase().replace('(leave blank)', '');
                    const isCorrect = userAnswer === (part.answer === '--' ? '' : part.answer.toLowerCase());
                    const inputEl = document.querySelector(`[name="${partIdName}"]`);
                    
                    if (inputEl) {
                        inputEl.value = userAnswers[partIdName] || ''; // Display user's answer (original case)
                        inputEl.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
                        if (!isCorrect) {
                            const feedbackContainer = document.createElement('div');
                            feedbackContainer.className = 'feedback-container mt-1 flex items-center gap-2';
                            
                            const correctAnswerEl = document.createElement('div');
                            correctAnswerEl.className = 'correct-answer-box text-xs font-semibold bg-green-100 border border-green-200 text-green-800 p-1 rounded';
                            const correctAnswer = part.answer === '--' ? '(blank)' : part.answer;
                            correctAnswerEl.textContent = `Correct: ${correctAnswer}`;
                            
                            const markCorrectBtn = document.createElement('button');
                            markCorrectBtn.type = 'button';
                            markCorrectBtn.className = 'mark-correct-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded-lg transition-colors';
                            markCorrectBtn.textContent = '✓';
                            markCorrectBtn.title = 'Mark as Correct';
                            markCorrectBtn.addEventListener('click', (e) => {
                                inputEl.classList.remove('incorrect-answer');
                                inputEl.classList.add('correct-answer');
                                e.target.parentElement.remove();
                            });

                            feedbackContainer.appendChild(correctAnswerEl);
                            feedbackContainer.appendChild(markCorrectBtn);
                            
                            inputEl.parentElement.appendChild(feedbackContainer);
                        }
                    }
                    // Explicitly load note for this part if it exists
                    const noteIdForPart = `${q.displayNum}_part${index}`; // Use the correct ID for notes
                    const noteArea = document.getElementById(`notes-${noteIdForPart}`);
                    if (noteArea) {
                        const savedNote = localStorage.getItem(`notes-${noteIdForPart}`);
                        if (savedNote) {
                            noteArea.value = savedNote;
                            // Ensure notes container is visible
                            const notesContentDiv = noteArea.closest('.notes-content');
                            const notesToggleButton = notesContentDiv ? notesContentDiv.previousElementSibling : null;
                            if (notesContentDiv && notesContentDiv.classList.contains('hidden')) {
                                notesContentDiv.classList.remove('hidden');
                                if (notesToggleButton) {
                                    notesToggleButton.textContent = 'Hide Notes';
                                }
                            }
                        }
                    }
                });
            } else { // Handles mc, input_correction, and input_rewrite
                const inputEl = document.querySelector(`[name="q${q.displayNum}"]`);
                if (!inputEl) return;
                
                const userAnswer = (userAnswers[`q${q.displayNum}`] || '').toLowerCase();
                let isCorrect = false;
                if (q.type === 'mc') {
                    isCorrect = userAnswer.toUpperCase() === q.answer;
                    inputEl.classList.add('review-select');
                    inputEl.value = userAnswer; // Set selected value for MC

                    // Highlight selected option and correct option in the displayed choices
                    const optionsDisplay = wrapper.querySelector('.mc-options-display');
                    if (optionsDisplay) {
                        optionsDisplay.querySelectorAll('.mc-option-item').forEach(item => {
                            const optionValue = item.textContent.match(/\((.)\)/)[1]; // Extract A, B, C, D
                            if (optionValue === q.answer) {
                                item.classList.add('correct');
                            }
                            if (optionValue === userAnswer.toUpperCase() && optionValue !== q.answer) {
                                item.classList.add('incorrect-selected');
                            }
                        });
                    }

                } else { // input_correction and input_rewrite
                    isCorrect = userAnswer === q.answer.toLowerCase().replace(/[.,]/g, '');
                    // Display user's answer in the textarea
                    inputEl.value = userAnswers[`q${q.displayNum}`] || ''; // Use original case for display

                    if (!isCorrect) {
                        const feedbackContainer = document.createElement('div');
                        feedbackContainer.className = 'feedback-container mt-2 flex items-center gap-4';
                        
                        const correctAnswerEl = document.createElement('div');
                        correctAnswerEl.className = 'correct-answer-box text-sm font-semibold bg-green-100 border border-green-200 text-green-800 py-1 px-3 rounded-md';
                        correctAnswerEl.textContent = `Correct: ${q.answer}`;
                        
                        const markCorrectBtn = document.createElement('button');
                        markCorrectBtn.type = 'button';
                        markCorrectBtn.className = 'mark-correct-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded-lg transition-colors';
                        markCorrectBtn.textContent = 'Mark as Correct';
                        markCorrectBtn.addEventListener('click', (e) => {
                            inputEl.classList.remove('incorrect-answer');
                            inputEl.classList.add('correct-answer');
                            e.target.parentElement.remove();
                        });
                        
                        feedbackContainer.appendChild(correctAnswerEl);
                        feedbackContainer.appendChild(markCorrectBtn);
                        inputEl.parentElement.appendChild(feedbackContainer);
                    }
                }
                inputEl.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');

                // Load note for this question if it exists
                const noteArea = document.getElementById(`notes-${q.displayNum}`); // Use displayNum for notes
                if (noteArea) {
                    const savedNote = localStorage.getItem(`notes-${q.displayNum}`);
                    if (savedNote) {
                        noteArea.value = savedNote;
                        const notesContentDiv = noteArea.closest('.notes-content');
                        const notesToggleButton = notesContentDiv ? notesContentDiv.previousElementSibling : null;
                        if (notesContentDiv && notesContentDiv.classList.contains('hidden')) {
                            notesContentDiv.classList.remove('hidden');
                            if (notesToggleButton) {
                                notesToggleButton.textContent = 'Hide Notes';
                            }
                        }
                    }
                }
            }
            
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'explain-btn text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-full transition-colors mt-4';
            btn.textContent = 'Explain';
            wrapper.appendChild(btn);
            const explanationContent = document.createElement('div');
            explanationContent.className = 'explanation-content hidden mt-3 pt-3 border-t border-slate-200 text-sm text-slate-700 prose max-w-none';
            if (q.type === 'paragraph_input') {
                 explanationContent.innerHTML = q.parts.map((p, i) => `<div><p><b>Blank ${i+1} (${p.answer === '--' ? 'blank' : p.answer}):</b> ${p.explanation}</p></div>`).join('');
            } else {
                 explanationContent.innerHTML = q.explanation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
            wrapper.appendChild(explanationContent);
        });

        document.querySelectorAll('.explain-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const content = e.target.closest('.question-block').querySelector('.explanation-content');
                content.classList.toggle('hidden');
                e.target.textContent = content.classList.contains('hidden') ? 'Explain' : 'Hide';
            });
        });
    }
    
    function showDiagnostics() {
        testContainer.classList.add('hidden');
        document.getElementById('intro-view').classList.add('hidden');
        diagnosticsView.classList.remove('hidden');
        
        const allCompleted = testState[1].completed && testState[2].completed && testState[3].completed;
        
        document.getElementById('diag-tab-block-a').disabled = !testState[1].completed;
        document.getElementById('diag-tab-block-b').disabled = !testState[2].completed;
        document.getElementById('diag-tab-block-c').disabled = !testState[3].completed;
        document.getElementById('diag-tab-overall').disabled = !allCompleted;

        let firstActiveTab = '';
        if (allCompleted) firstActiveTab = 'overall';
        else if (testState[1].completed) firstActiveTab = 'block-a';
        else if (testState[2].completed) firstActiveTab = 'block-b';
        else if (testState[3].completed) firstActiveTab = 'block-c';
        
        if(firstActiveTab) switchDiagTab(firstActiveTab);

        renderAllCharts();
    }

    function renderAllCharts() {
        const results = [];
        testData.forEach(q => {
            if (!testState[q.block].completed) return;
            const blockAnswers = testState[q.block].answers;
            if (q.type === 'paragraph_input') {
                q.parts.forEach((part, index) => {
                    const userAnswer = (blockAnswers[`q${q.displayNum}_part${index}`] || '').toLowerCase().replace('(leave blank)', '');
                    const isCorrect = userAnswer === (part.answer === '--' ? '' : part.answer.toLowerCase());
                    results.push({ ...q, category: q.category, isCorrect });
                });
            } else {
                 const userAnswer = (blockAnswers[`q${q.displayNum}`] || '').toLowerCase();
                 let isCorrect = false;
                 if (q.type === 'mc') isCorrect = userAnswer.toUpperCase() === q.answer;
                 else isCorrect = userAnswer === q.answer.toLowerCase().replace(/[.,]/g, '');
                 results.push({ ...q, isCorrect });
            }
        });

        if (testState[1].completed && testState[2].completed && testState[3].completed) {
            renderDiagnosticChart('overallChart', results);
        }
        if (testState[1].completed) renderDiagnosticChart('blockAChart', results.filter(r => r.block === 1));
        if (testState[2].completed) renderDiagnosticChart('blockBChart', results.filter(r => r.block === 2));
        if (testState[3].completed) renderDiagnosticChart('blockCChart', results.filter(r => r.block === 3));
    }

    function renderDiagnosticChart(canvasId, results) {
        const categories = [...new Set(results.map(r => r.category))];
        
        const categoryData = categories.map(cat => {
            const catQuestions = results.filter(r => r.category === cat);
            const correctCount = catQuestions.filter(r => r.isCorrect).length;
            const totalCount = catQuestions.length;
            const score = totalCount > 0 ? (correctCount / totalCount) * 100 : 0;
            return { category: cat, score, raw: `${correctCount}Q/${totalCount}Q` };
        });

        const ctx = document.getElementById(canvasId).getContext('2d');
        if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
        
        chartInstances[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categoryData.map(d => d.category),
                datasets: [{
                    label: '% Correct',
                    data: categoryData.map(d => d.score),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true, max: 100, ticks: { color: '#64748b' }, grid: { color: 'rgba(226, 232, 240, 0.5)' } },
                    y: { ticks: { color: '#334155' }, grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.raw.toFixed(1)}%` } },
                    datalabels: {
                        anchor: 'end', align: 'end', color: '#1e293b', font: { weight: 'bold' },
                        formatter: (value, context) => categoryData[context.dataIndex].raw
                    }
                }
            }
        });
    }

    document.getElementById('back-to-review-btn').addEventListener('click', () => {
        diagnosticsView.classList.add('hidden');
        testContainer.classList.remove('hidden');
        document.getElementById('intro-view').classList.remove('hidden');
        // Re-render the current block to ensure review mode is active if applicable
        renderQuestions(currentBlock); 
    });

    function switchDiagTab(tabName) {
        const targetId = `diag-content-${tabName}`;
        diagTabs.forEach(t => {
            t.classList.toggle('tab-active', t.dataset.tab === tabName);
            t.classList.toggle('tab-inactive', t.dataset.tab !== tabName);
        });
        document.querySelectorAll('.diag-content').forEach(content => {
            content.classList.toggle('hidden', content.id !== targetId);
        });
    }

    diagTabs.forEach(tab => {
        tab.addEventListener('click', () => { if(!tab.disabled) switchDiagTab(tab.dataset.tab); });
    });

    // --- START: Custom Alert/Confirm Modals ---
    function showCustomAlert(message) {
        const modalId = 'custom-alert-modal';
        let modal = document.getElementById(modalId);
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <p class="text-slate-800 text-center mb-4" id="custom-alert-message"></p>
                    <button id="custom-alert-ok-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg w-full">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('custom-alert-ok-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
        document.getElementById('custom-alert-message').textContent = message;
        modal.classList.remove('hidden');
    }

    function showCustomConfirm(message, onConfirm) {
        const modalId = 'custom-confirm-modal';
        let modal = document.getElementById(modalId);
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <p class="text-slate-800 text-center mb-4" id="custom-confirm-message"></p>
                    <div class="flex justify-around gap-4">
                        <button id="custom-confirm-cancel-btn" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg flex-1">Cancel</button>
                        <button id="custom-confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex-1">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        document.getElementById('custom-confirm-message').textContent = message;
        modal.classList.remove('hidden');

        const okBtn = document.getElementById('custom-confirm-ok-btn');
        const cancelBtn = document.getElementById('custom-confirm-cancel-btn');

        // Clear previous listeners to prevent multiple calls
        const newOkHandler = () => {
            modal.classList.add('hidden');
            onConfirm();
            okBtn.removeEventListener('click', newOkHandler);
            cancelBtn.removeEventListener('click', newCancelHandler);
        };
        const newCancelHandler = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', newOkHandler);
            cancelBtn.removeEventListener('click', newCancelHandler);
        };

        okBtn.addEventListener('click', newOkHandler);
        cancelBtn.addEventListener('click', newCancelHandler);
    }
    // --- END: Custom Alert/Confirm Modals ---

    // Initial render
    switchTab(currentBlock);
});
</script>
</body>
</html>
